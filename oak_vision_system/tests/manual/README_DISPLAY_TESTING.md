# 显示模块测试指南

## 概述

本文档说明如何测试显示模块的重构功能，包括自动化测试和手动测试。

## 自动化测试结果

### 测试执行命令

```bash
python -m pytest oak_vision_system/tests/unit/modules/display_modules/ -v
```

### 测试结果总结（更新于 2024-01-26）

**总计：81 个测试**
- ✅ **通过：81 个测试（100%）**
- ❌ **失败：0 个测试**

### 测试清理说明

**已完成的清理工作：**

`test_display_renderer_window_management.py` 文件已经完全重写，以适配新的单窗口策略：

**删除的测试（旧的多窗口策略）：**
- ❌ `test_window_title_format` - 测试每个设备独立窗口的标题
- ❌ `test_window_title_without_alias` - 测试无别名时的窗口标题
- ❌ `test_toggle_fullscreen_multiple_windows` - 测试多窗口全屏切换
- ❌ `test_window_creation_error_handling` - 测试旧的 `_create_window()` 方法

**新增的测试（单窗口策略）：**
- ✅ `test_main_window_creation` - 测试主窗口创建
- ✅ `test_window_size_single_device_mode` - 测试单设备模式窗口大小（640x480）
- ✅ `test_window_size_combined_mode` - 测试 Combined 模式窗口大小（1280x480）
- ✅ `test_window_position_setting` - 测试窗口位置设置
- ✅ `test_window_position_not_set_when_zero` - 测试位置为零时不设置
- ✅ `test_fullscreen_mode_enabled` - 测试全屏模式启用
- ✅ `test_fullscreen_mode_disabled` - 测试全屏模式禁用
- ✅ `test_toggle_fullscreen_to_fullscreen` - 测试切换到全屏
- ✅ `test_toggle_fullscreen_to_windowed` - 测试切换到窗口模式
- ✅ `test_toggle_fullscreen_without_window` - 测试窗口未创建时的全屏切换

**核心变化：**
1. **单窗口策略**：只有一个主窗口 `"OAK Display"`
2. **显示切换**：通过按键切换窗口中显示的内容，而不是切换窗口
3. **全屏管理**：使用 `self._is_fullscreen` 而不是 `self._fullscreen_states[window_name]`
4. **窗口大小**：根据显示模式动态调整（单设备 640x480，Combined 1280x480）

### 通过的测试类别

✅ **深度输出配置测试** (7个测试)
- 深度输出配置传递
- 深度可视化功能
- 百分位数归一化
- HOT颜色映射

✅ **优雅关闭测试** (6个测试)
- 管理器停止两个模块
- 打包器清理资源
- 渲染器关闭窗口
- 超时警告日志

✅ **按键切换测试** (7个测试)
- 设备切换方法
- Combined模式切换
- 按键提示绘制
- 设备别名显示

✅ **性能测试** (6个测试)
- 帧率限制
- 图像复制优化
- 队列使用率监控
- 高队列使用警告

✅ **按标签着色测试** (5个测试)
- 颜色调色板
- 按标签着色启用/禁用
- 颜色选择算法
- 空帧处理

✅ **显示模式测试** (12个测试)
- 初始显示模式
- 单设备渲染
- Combined模式渲染
- 深度可视化
- 模式切换

✅ **空帧处理测试** (5个测试)
- 空检测框绘制
- 空帧验证
- 混合空帧和非空帧

✅ **FPS和设备信息测试** (8个测试)
- FPS计算和显示
- 设备信息显示
- 时间戳管理

✅ **叠加信息测试** (8个测试)
- 标签显示
- 置信度显示
- 坐标显示
- 文本背景绘制

✅ **窗口管理测试** (10个测试) - **已更新**
- 主窗口创建
- 单设备模式窗口大小
- Combined模式窗口大小
- 窗口位置设置
- 全屏模式启用/禁用
- 全屏切换功能

✅ **统计信息测试** (6个测试)
- FPS历史收集
- 管理器统计结构
- 渲染器统计结构
- 线程安全


## 手动测试

由于某些功能需要实际的用户交互和视觉验证，我们提供了两个手动测试脚本。

### 测试脚本 1：按键切换测试

**文件：** `test_display_key_switching_manual.py`

**测试内容：**
- 按 '1' 键切换到第一个设备
- 按 '2' 键切换到第二个设备
- 按 '3' 键切换到 Combined 模式
- 按 'F' 键切换全屏/窗口模式
- 按 'Q' 键退出程序

**运行方法：**
```bash
cd oak_vision_system/tests/manual
python test_display_key_switching_manual.py
```

**预期结果：**
- 窗口显示两个模拟设备的视频流（蓝色和绿色背景）
- 按键响应正常，显示模式正确切换
- 全屏切换功能正常
- 退出功能正常

### 测试脚本 2：多设备场景测试

**文件：** `test_display_multi_device_manual.py`

**测试内容：**
- 场景1：只有一个设备在线（自动单设备显示）
- 场景2：两个设备都在线（Combined模式拼接）
- 场景3：设备动态上线/下线（自动切换）

**运行方法：**
```bash
cd oak_vision_system/tests/manual
python test_display_multi_device_manual.py
```

**预期结果：**
- 场景1：显示单个设备的视频流（蓝色背景）
- 场景2：水平拼接两个设备的视频流（左蓝右绿）
- 场景3：设备下线时自动切换到单设备显示，上线时自动切换回Combined模式

## 测试检查清单

### 自动化测试
- [x] 运行所有单元测试
- [x] 81个测试全部通过（100%）
- [x] 清理过时的窗口管理测试
- [x] 更新测试以适配单窗口策略

### 手动测试 - 按键切换
- [ ] 按 '1' 键能切换到第一个设备
- [ ] 按 '2' 键能切换到第二个设备
- [ ] 按 '3' 键能切换到 Combined 模式
- [ ] 按 'F' 键能切换全屏/窗口模式
- [ ] 按 'Q' 键能退出程序
- [ ] 按键提示信息正确显示

### 手动测试 - 多设备场景
- [ ] 单设备显示正常（场景1）
- [ ] 双设备Combined模式正常（场景2）
- [ ] 设备动态切换正常（场景3）
- [ ] 设备名称标签正确显示
- [ ] 窗口大小自适应正确

## 已知问题

### ~~窗口管理测试失败~~ ✅ 已解决

**问题：** `test_display_renderer_window_management.py` 中的10个测试失败

**原因：** 这些测试针对旧的多窗口策略（`_create_window()` 方法），而当前实现已经重构为单窗口策略（`_create_main_window()` 方法）

**解决方案：** ✅ 已完成
- 重写了 `test_display_renderer_window_management.py` 文件
- 删除了针对多窗口策略的过时测试
- 新增了适配单窗口策略的测试
- 所有测试现在都能通过（81/81）

**更新日期：** 2024-01-26

## 总结

显示模块的重构已经完成，核心功能已经通过自动化测试验证：

✅ **已验证的功能：**
1. 单窗口显示策略
2. 按键切换功能（1/2/3/F/Q）
3. Combined模式（双设备拼接）
4. 单设备显示模式
5. 深度输出配置
6. FPS和设备信息显示
7. 检测框和叠加信息
8. 按标签着色
9. 性能优化
10. 优雅关闭

⚠️ **需要手动验证的功能：**
1. 按键交互体验
2. 全屏切换效果
3. 设备动态切换的视觉效果
4. 窗口大小自适应

📝 **后续工作：**
1. 运行手动测试脚本，验证用户交互功能
2. ~~清理或更新过时的窗口管理测试~~ ✅ 已完成
3. 根据手动测试结果进行必要的调整

## 联系方式

如有问题或需要帮助，请联系开发团队。
