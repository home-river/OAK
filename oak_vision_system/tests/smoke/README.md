# 系统冒烟测试

## 概述

完整的系统集成冒烟测试，验证所有模块的正常工作。

## 测试内容

### 测试流程

1. **配置加载** - 通过 DeviceConfigManager 加载配置文件
2. **模块创建** - 创建所有系统模块
   - 事件总线（EventBus）
   - OAK 设备管理器（PipelineManager）
   - 数据处理模块（DataProcessor）
   - CAN 通信器（虚拟模式）
3. **模块注册** - 将所有模块注册到 SystemManager
4. **系统启动** - 启动完整的检测流
5. **运行监控** - 运行指定时间并监控系统状态
6. **优雅关闭** - 停止所有模块并清理资源

### 测试特点

- ✅ 使用真实 OAK 设备进行检测
- ✅ 使用虚拟 CAN 通信器（适用于 Windows）
- ✅ 完整的端到端数据流测试
- ✅ 实时监控和统计信息
- ✅ 支持 Ctrl+C 优雅中断

## 使用方法

### 前置条件

1. **硬件要求**
   - 至少一个 OAK 设备已连接
   - 设备 MXID 与配置文件中的绑定匹配

2. **配置文件**
   - 确保配置文件存在：`assets/test_config/config.json`
   - 确保 `enable_can` 设置为 `false`（使用虚拟 CAN）

3. **环境要求**
   - Python 3.10+
   - 已安装所有依赖包

### 运行测试

#### 方法 1: 直接运行（默认 60 秒）

```bash
python oak_vision_system/tests/smoke/smoke.py
```

#### 方法 2: 从项目根目录运行

```bash
cd /path/to/OAK
python -m oak_vision_system.tests.smoke.smoke
```

#### 方法 3: 自定义测试时长

修改 `smoke.py` 中的 `test_duration` 变量：

```python
# 测试运行时长（秒）
test_duration = 120  # 改为 120 秒
```

### 测试输出

测试运行时会显示：

1. **配置信息**
   - 配置版本
   - OAK 设备配置
   - 设备角色绑定
   - CAN 配置
   - 数据处理配置

2. **模块创建进度**
   - 每个模块的创建状态
   - 模块类型和配置

3. **系统启动状态**
   - 各模块启动结果
   - 连接状态

4. **运行时统计**（每 10 秒）
   - 运行时间
   - 虚拟 CAN 统计
     - 警报触发次数
     - 警报清除次数
     - 坐标请求次数
     - 当前警报状态

5. **最终总结**
   - 测试项目清单
   - 测试结果

### 示例输出

```
================================================================================
OAK Vision System - 完整系统冒烟测试
================================================================================

测试配置:
  • 真实 OAK 设备连接
  • 虚拟 CAN 通信（Windows 环境）
  • 完整数据流测试

配置文件: assets/test_config/config.json
测试时长: 60 秒

================================================================================
步骤 1: 加载配置文件
================================================================================
配置文件路径: D:\pythonWork\graspWithVision\OAK\assets\test_config\config.json
正在加载配置...
✅ 配置加载成功
   配置版本: 2.0.0

关键配置信息:

[OAK 设备配置]
  模型路径: assets/test_config/yolov8.blob
  标签映射: ['durian', 'person']
  置信度阈值: 0.5

[设备角色绑定]
  left_camera:
    • 活跃设备: 19443010C122201300
    • 历史设备: ['19443010C122201300']
  right_camera:
    • 活跃设备: 19443010F1221E1300
    • 历史设备: ['19443010F1221E1300']

[CAN 通信配置]
  enable_can: False
  接口类型: socketcan
  通道: can0
  波特率: 250000
  ✅ 将使用虚拟 CAN 模式（适用于 Windows）

================================================================================
步骤 2: 创建系统模块
================================================================================

[2.1] 创建事件总线
✅ 事件总线创建成功

[2.2] 创建 PipelineManager（OAK 设备管理器）
      这将连接真实的 OAK 设备...
✅ PipelineManager 创建成功
   OAK 设备已准备就绪

[2.3] 创建 DataProcessor（数据处理模块）
✅ DataProcessor 创建成功
   包含: 坐标转换器、滤波器、决策层

[2.4] 使用工厂函数创建 CAN 通信器
✅ CAN 通信器创建成功: VirtualCANCommunicator
   虚拟 CAN 模式（适用于 Windows 开发环境）

[2.5] 创建 SystemManager 并注册模块
✅ SystemManager 创建成功
   已注册 4 个模块:
     • event_bus
     • pipeline_manager
     • data_processor
     • can_communicator

================================================================================
步骤 3: 启动系统
================================================================================

[3.1] 启动 PipelineManager...
      正在连接 OAK 设备并初始化检测流...
✅ PipelineManager 启动成功
   OAK 设备检测流已启动

[3.2] 启动 DataProcessor...
✅ DataProcessor 启动成功
   数据处理流水线已就绪

[3.3] 启动 CAN 通信器...
✅ CAN 通信器启动成功
   已订阅 PERSON_WARNING 事件

================================================================================
✅ 所有模块启动成功！系统正在运行...
================================================================================

================================================================================
步骤 4: 运行并监控系统（60 秒）
================================================================================

系统监控说明:
  • OAK 设备正在实时检测
  • 数据处理模块正在处理检测结果
  • 虚拟 CAN 正在监听警报事件
  • 每 10 秒显示一次统计信息
  • 按 Ctrl+C 可提前停止

--------------------------------------------------------------------------------
运行时间: 10/60 秒
--------------------------------------------------------------------------------

[虚拟 CAN 统计]
  运行状态: 运行中
  警报状态: ✅ 正常
  警报触发次数: 2
  警报清除次数: 2
  坐标请求次数: 0

...

✅ 测试运行完成（60 秒）

================================================================================
最终统计信息
================================================================================

[虚拟 CAN 最终统计]
  总运行时间: 60 秒
  警报触发总次数: 5
  警报清除总次数: 5
  坐标请求总次数: 0
  最终警报状态: 正常

================================================================================
步骤 5: 停止系统
================================================================================

[5.1] 停止 CAN 通信器...
✅ CAN 通信器已停止

[5.2] 停止 DataProcessor...
✅ DataProcessor 已停止

[5.3] 停止 PipelineManager...
✅ PipelineManager 已停止

[5.4] 使用 SystemManager 执行最终关闭...
✅ SystemManager 已关闭

✅ 所有模块已停止

================================================================================
冒烟测试总结
================================================================================

测试项目:
  ✅ 配置文件加载
  ✅ 事件总线创建
  ✅ OAK 设备连接（真实硬件）
  ✅ 数据处理模块创建
  ✅ 虚拟 CAN 通信器创建
  ✅ SystemManager 注册
  ✅ 系统启动
  ✅ 检测流运行
  ✅ 事件处理
  ✅ 系统停止

测试结果: 🎉 所有测试通过！

系统集成验证成功，可以投入使用。
```

## 故障排除

### 问题 1: 配置文件不存在

**错误信息**:
```
❌ 配置文件不存在: assets/test_config/config.json
```

**解决方法**:
- 确保配置文件路径正确
- 从项目根目录运行测试
- 或修改 `config_path` 变量为绝对路径

### 问题 2: OAK 设备未连接

**错误信息**:
```
❌ PipelineManager 启动失败
   可能原因:
     • OAK 设备未连接
```

**解决方法**:
- 检查 OAK 设备是否已连接到电脑
- 使用 `python tools/config_tools/discover_devices.py` 发现设备
- 确认设备 MXID 与配置文件匹配

### 问题 3: 设备 MXID 不匹配

**错误信息**:
```
设备匹配失败
```

**解决方法**:
- 运行设备发现工具更新配置
- 或手动修改配置文件中的 `active_mxid`

### 问题 4: 模型文件不存在

**错误信息**:
```
模型文件不存在
```

**解决方法**:
- 确保 `assets/test_config/yolov8.blob` 文件存在
- 或修改配置文件中的 `model_path`

### 问题 5: 使用了真实 CAN

**警告信息**:
```
⚠️  警告: enable_can=True，将尝试连接真实 CAN 硬件
```

**解决方法**:
- 在配置文件中设置 `"enable_can": false`
- Windows 环境建议使用虚拟 CAN

## 注意事项

1. **测试时长**: 默认 60 秒，可根据需要调整
2. **设备连接**: 确保 OAK 设备在测试前已连接
3. **虚拟 CAN**: Windows 环境必须使用虚拟 CAN（`enable_can: false`）
4. **中断测试**: 按 Ctrl+C 可以优雅中断测试
5. **日志输出**: 所有日志输出到控制台，可重定向到文件

## 相关文件

- `smoke.py` - 主测试脚本
- `assets/test_config/config.json` - 测试配置文件
- `oak_vision_system/modules/config_manager/` - 配置管理器
- `oak_vision_system/modules/data_collector/pipelinemanager.py` - OAK 设备管理器
- `oak_vision_system/modules/data_processing/data_processor.py` - 数据处理模块
- `oak_vision_system/modules/can_communication/can_factory.py` - CAN 工厂函数

## 扩展测试

如果需要更详细的测试，可以：

1. 增加测试时长
2. 添加更多的监控指标
3. 模拟特定的检测场景
4. 添加性能基准测试
5. 集成到 CI/CD 流程

## 支持

如有问题，请查看：
- 项目文档
- 模块 README
- 单元测试示例
