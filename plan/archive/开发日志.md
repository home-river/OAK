# OAK视觉系统开发日志

## 2025-10-10

### 架构设计确认

#### 分层架构设计
确认了系统的三层架构：

1. **设备发现模块（`modules/device_discovery.py`）**
   - 职责：扫描USB连接的OAK设备，提取设备元数据
   - 范围：纯API，无配置逻辑、用户交互、文件操作
   - 输出：`List[DeviceMetadataDTO]`

2. **设备配置管理器（`modules/device_config_manager.py`）** - 待开发
   - 职责：配置的创建、读取、保存、验证、设备匹配
   - 范围：配置文件CRUD、设备角色绑定、historical_mxids管理
   - 核心方法：
     - `load_config()` - 加载配置文件
     - `save_config()` - 保存配置文件
     - `create_default_config()` - 创建默认配置
     - `match_devices()` - 匹配在线设备到角色
     - `validate_config()` - 验证配置完整性

3. **CLI工具（`tools/device_binding_tool.py`）** - 待重构
   - 职责：用户交互、设备预览、角色绑定、参数配置
   - 范围：交互式流程、RGB预览、配置向导
   - 核心功能：
     - 设备发现与展示
     - 交互式角色选择
     - OAK硬件参数配置
     - 配置查看与编辑

#### 配置与运行分离设计
- **配置阶段**：使用CLI工具进行设备绑定和参数配置，保存到配置文件
- **运行阶段**：检测流通过配置管理器读取配置，自动匹配设备并启动
- **优势**：
  - 配置持久化，重启不丢失
  - 支持无人值守运行
  - 配置可版本管理
  - 设备热插拔自动识别

---

### 重构完成：设备发现模块

#### 重构内容
**移除的功能**（已转移到配置管理器和CLI工具）：
- ❌ `create_role_bindings()` - 角色绑定逻辑 → 移至配置管理器
- ❌ `create_oak_module_config()` - 配置组装 → 移至配置管理器
- ❌ `print_device_summary()` - 格式化输出 → 移至CLI工具
- ❌ `print_oak_module_summary()` - 格式化输出 → 移至CLI工具

**保留的功能**（核心API）：
- ✅ `discover_devices(verbose=False)` - 发现所有OAK设备
- ✅ `_get_product_name()` - 获取设备产品名称
- ✅ `_parse_connection_state()` - 解析连接状态
- ✅ `_detect_device_type()` - 检测设备类型

**改进**：
- 默认 `verbose=False`，更适合作为库使用
- 移除不必要的导入（DeviceRoleBindingDTO、DeviceRole、OAKModuleConfigDTO）
- 更新文档字符串，明确职责边界
- 精简到 174 行（原 261 行）

#### 设计理念
```
单一职责：仅负责硬件扫描和信息提取
无状态：所有方法为静态方法
纯API：不包含配置逻辑、用户交互、文件操作
```

---

### 下一步开发计划

#### 阶段1：创建设备配置管理器（优先级：高）
**任务**：
- [ ] 创建 `modules/device_config_manager.py`
- [ ] 实现配置加载/保存（JSON序列化）
- [ ] 实现设备匹配算法（基于historical_mxids）
- [ ] 实现配置验证逻辑
- [ ] 实现工厂方法（create_default_config）
- [ ] 编写单元测试

**关键设计**：
```python
class DeviceConfigManager:
    def __init__(self, config_path: str)
    def load_config() -> bool
    def save_config() -> bool
    def match_devices(online_devices) -> Dict[DeviceRole, str]
    def validate_config() -> Tuple[bool, List[str]]
    @staticmethod
    def create_default_config(...) -> OAKModuleConfigDTO
```

#### 阶段2：重构CLI工具（优先级：高）
**任务**：
- [ ] 重构 `tools/device_binding_tool.py`
- [ ] 实现交互式角色选择流程
- [ ] 实现RGB预览功能（帮助用户识别设备位置）
- [ ] 实现OAK硬件参数配置向导
- [ ] 添加配置查看/编辑功能
- [ ] 添加命令行参数支持

**命令行接口设计**：
```bash
# 交互式绑定
python -m tools.device_binding_tool bind

# 查看当前配置
python -m tools.device_binding_tool show

# 验证配置
python -m tools.device_binding_tool validate

# 重置配置
python -m tools.device_binding_tool reset
```

#### 阶段3：更新示例代码（优先级：中）
**任务**：
- [ ] 更新 `examples/device_discovery_example.py`（适配重构后的API）
- [ ] 创建 `examples/config_manager_example.py`（展示配置管理器用法）
- [ ] 创建 `examples/complete_workflow_example.py`（完整工作流演示）

#### 阶段4：集成测试（优先级：中）
**任务**：
- [ ] 端到端测试：设备发现 → 角色绑定 → 保存配置 → 加载配置
- [ ] 设备热插拔测试
- [ ] 配置文件兼容性测试
- [ ] 多设备场景测试

---

### 技术债务与改进项
- [ ] 将 `verbose` 输出替换为 `logging` 模块（更灵活的日志控制）
- [ ] 添加设备连接超时处理
- [ ] 添加设备健康检查功能
- [ ] 考虑异步设备发现（提升多设备场景性能）

---

### 参考资料
- 设计文档：`plan/设备角色绑定架构设计方案.md`
- 配置DTO说明：`plan/dto/配置DTO说明.md`
- 开发计划：`plan/OAK模块重构开发计划v2.md`

