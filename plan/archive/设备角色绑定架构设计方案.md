# è®¾å¤‡è§’è‰²ç»‘å®šæ¶æ„è®¾è®¡æ–¹æ¡ˆ

> **åˆ›å»ºæ—¥æœŸ**: 2025-10-08  
> **çŠ¶æ€**: å¾…ç¡®è®¤

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### è®¾å¤‡è§’è‰²ï¼ˆRoleï¼‰vs è®¾å¤‡MXid

```
ç±»æ¯”ï¼šè½¦çš„å››ä¸ªè½®å­
â”œâ”€ è½®å­ä½ç½®ï¼ˆRoleï¼‰     â†’ å›ºå®šçš„åŠŸèƒ½ä½ç½®ï¼ˆå·¦å‰ã€å³å‰ã€å·¦åã€å³åï¼‰
â”œâ”€ è½®å­æœ¬èº«ï¼ˆMXidï¼‰     â†’ å¯æ›´æ¢çš„ç‰©ç†è®¾å¤‡
â””â”€ å†å²è½®å­è®°å½•         â†’ è®°ä½æ›¾ç»ç”¨è¿‡çš„æ‰€æœ‰è½®å­
```

**å…³é”®ç‰¹æ€§**ï¼š
1. **Role æ˜¯ä¸»é”®** - åŠŸèƒ½ä½ç½®æ˜¯å›ºå®šçš„ï¼Œç”¨æšä¸¾è¡¨ç¤º
2. **MXid å¯æ›´æ¢** - è®¾å¤‡æŸåå¯ä»¥æ›´æ¢ï¼Œç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«
3. **é…ç½®è·Ÿéš Role** - åæ ‡å˜æ¢ç­‰å‚æ•°ç»‘å®šåˆ°è§’è‰²ï¼Œä¸ç»‘å®šåˆ°MXid
4. **è‡ªåŠ¨è¯†åˆ«æœºåˆ¶** - è®°ä½å†å²MXidï¼Œå¯åŠ¨æ—¶è‡ªåŠ¨åŒ¹é…

---

## ğŸ“ DTOæ¶æ„è®¾è®¡

### 1. DeviceRoleï¼ˆæšä¸¾ï¼‰

```python
class DeviceRole(Enum):
    """è®¾å¤‡åŠŸèƒ½è§’è‰²æšä¸¾"""
    LEFT_CAMERA = "left_camera"
    RIGHT_CAMERA = "right_camera"
    CENTER_CAMERA = "center_camera"  # é¢„ç•™
    UNKNOWN = "unknown"
```

---

### 2. DeviceRoleBindingDTOï¼ˆè§’è‰²ç»‘å®šï¼‰

```python
@dataclass
class DeviceRoleBindingDTO(BaseDTO):
    """è®¾å¤‡è§’è‰²ç»‘å®š"""
    
    # æ ¸å¿ƒå­—æ®µ
    role: DeviceRole                          # åŠŸèƒ½è§’è‰²ï¼ˆä¸»é”®ï¼‰
    historical_mxids: List[str]               # æ›¾ç»ä½¿ç”¨è¿‡çš„MXid
    
    # è¿è¡Œæ—¶çŠ¶æ€
    active_mxid: Optional[str] = None         # å½“å‰æ¿€æ´»çš„MXidï¼ˆè¿è¡Œæ—¶ï¼Œä¸æŒä¹…åŒ–ï¼‰
    last_active_mxid: Optional[str] = None    # ä¸Šæ¬¡ä½¿ç”¨çš„MXidï¼ˆæŒä¹…åŒ–ï¼‰
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç”¨é€” | æŒä¹…åŒ– | ç¤ºä¾‹ |
|-----|------|--------|------|
| `role` | åŠŸèƒ½è§’è‰²ï¼Œä¸»é”® | âœ… | `DeviceRole.LEFT_CAMERA` |
| `historical_mxids` | æ›¾ç»ç”¨è¿‡çš„MXidåˆ—è¡¨ | âœ… | `["MXid_A", "MXid_B"]` |
| `active_mxid` | å½“å‰æ¿€æ´»çš„MXid | âŒ | `"MXid_A"` |
| `last_active_mxid` | ä¸Šæ¬¡ä½¿ç”¨çš„MXid | âœ… | `"MXid_B"` |

**è‡ªåŠ¨è¯†åˆ«æµç¨‹**ï¼š
```python
# ç³»ç»Ÿå¯åŠ¨
online_mxids = dai.DeviceBootloader.getAllAvailableDevices()
# è¿”å›: ["MXid_A", "MXid_C"]

# éå†æ¯ä¸ªè§’è‰²
for role, binding in role_bindings.items():
    # æ£€æŸ¥å†å²MXidä¸­æ˜¯å¦æœ‰åœ¨çº¿çš„
    for mxid in binding.historical_mxids:
        if mxid in online_mxids:
            binding.active_mxid = mxid  # è‡ªåŠ¨åŒ¹é…
            break
```

---

### 3. DeviceMetadataDTOï¼ˆè®¾å¤‡å…ƒæ•°æ®ï¼‰

```python
@dataclass
class DeviceMetadataDTO(BaseDTO):
    """è®¾å¤‡å…ƒæ•°æ®ï¼ˆæŒ‰MXidç´¢å¼•ï¼‰"""
    
    mxid: str                                 # è®¾å¤‡MXidï¼ˆä¸»é”®ï¼‰
    notes: Optional[str] = None               # ç”¨æˆ·å¤‡æ³¨
    device_type: DeviceType = DeviceType.UNKNOWN
    
    first_seen: float                         # é¦–æ¬¡å‘ç°æ—¶é—´
    last_seen: float                          # æœ€åå‘ç°æ—¶é—´
    health_status: Optional[str] = None       # "good" / "warning" / "error"
```

**ç”¨é€”**ï¼šä¸ºæ¯ä¸ªç‰©ç†è®¾å¤‡è®°å½•å¤‡æ³¨å’Œå…ƒä¿¡æ¯

---

### 4. CoordinateTransformConfigDTOï¼ˆåæ ‡å˜æ¢é…ç½®ï¼‰

```python
@dataclass
class CoordinateTransformConfigDTO(BaseDTO):
    """åæ ‡å˜æ¢é…ç½®ï¼ˆæŒ‰roleç´¢å¼•ï¼‰"""
    
    role: DeviceRole                          # åŠŸèƒ½è§’è‰²
    
    # å˜æ¢å‚æ•°
    translation: Tuple[float, float, float]   # å¹³ç§» (x, y, z) mm
    rotation: Tuple[float, float, float]      # æ—‹è½¬ (roll, pitch, yaw) åº¦
    scale: float = 1.0                        # ç¼©æ”¾å› å­
    
    # æ ‡å®šä¿¡æ¯
    calibration_date: Optional[str] = None
    calibration_method: Optional[str] = None  # "manual" / "auto"
    calibration_accuracy: Optional[float] = None  # ç²¾åº¦ (mm)
```

**å…³é”®è®¾è®¡**ï¼šåæ ‡å˜æ¢å‚æ•°ç»‘å®šåˆ°è§’è‰²ï¼Œè®¾å¤‡æ›´æ¢åå‚æ•°ä¸å˜ï¼

---

### 5. DeviceManagerConfigDTOï¼ˆé¡¶å±‚é…ç½®ï¼‰

```python
@dataclass
class DeviceManagerConfigDTO(BaseDTO):
    """è®¾å¤‡ç®¡ç†å™¨é…ç½®ï¼ˆæ•´åˆæ‰€æœ‰é…ç½®ï¼‰"""
    
    config_version: str = "2.0.0"
    
    # è®¾å¤‡è§’è‰²ç»‘å®šï¼ˆæŒ‰roleç´¢å¼•ï¼‰
    role_bindings: Dict[DeviceRole, DeviceRoleBindingDTO]
    
    # è®¾å¤‡å…ƒæ•°æ®ï¼ˆæŒ‰MXidç´¢å¼•ï¼‰
    device_metadata: Dict[str, DeviceMetadataDTO]
    
    # åæ ‡å˜æ¢é…ç½®ï¼ˆæŒ‰roleç´¢å¼•ï¼‰
    coordinate_transforms: Dict[DeviceRole, CoordinateTransformConfigDTO]
    
    # å…¶ä»–é…ç½®
    oak_config: OAKConfigDTO
    system: SystemConfigDTO
    filter_config: FilterConfigDTO
    pid_config: PIDConfigDTO
    
    # å†å²è®°å½•
    history: List[DeviceHistoryDTO]
    
    # é…ç½®é€‰é¡¹
    predefined_roles: List[DeviceRole]
    strict_mode: bool = True
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### åˆæ¬¡éƒ¨ç½²ï¼šè®¾å¤‡ç»‘å®š

```
è®¾å¤‡ç»‘å®šå·¥å…·ï¼ˆGUIï¼‰
â”œâ”€ 1. æ‰«æè®¾å¤‡
â”‚   â””â”€ dai.DeviceBootloader.getAllAvailableDevices()
â”‚      è¿”å›: ["MXid_A", "MXid_B", "MXid_C"]
â”‚
â”œâ”€ 2. è®¾å¤‡é¢„è§ˆ
â”‚   â”œâ”€ ç”¨æˆ·ç‚¹å‡» MXid_A
â”‚   â””â”€ å¯åŠ¨è§†é¢‘æµé¢„è§ˆ
â”‚
â”œâ”€ 3. è§’è‰²åˆ†é…
â”‚   â”œâ”€ ç”¨æˆ·é€‰æ‹© role = LEFT_CAMERA
â”‚   â”œâ”€ è¾“å…¥å¤‡æ³¨ notes = "2025å¹´10æœˆè´­å…¥"
â”‚   â””â”€ ç³»ç»Ÿæ‰§è¡Œ:
â”‚       â”œâ”€ role_bindings[LEFT_CAMERA].historical_mxids.append("MXid_A")
â”‚       â””â”€ device_metadata["MXid_A"].notes = "2025å¹´10æœˆè´­å…¥"
â”‚
â””â”€ 4. ä¿å­˜é…ç½®
    â””â”€ é…ç½®æ–‡ä»¶ä¿å­˜
```

---

### æ—¥å¸¸å¯åŠ¨ï¼šè‡ªåŠ¨è¯†åˆ«

```
ç³»ç»Ÿå¯åŠ¨
â”œâ”€ 1. åŠ è½½é…ç½®æ–‡ä»¶
â”‚   â””â”€ è¯»å– role_bindings å’Œ historical_mxids
â”‚
â”œâ”€ 2. æ‰«æåœ¨çº¿è®¾å¤‡
â”‚   â””â”€ online_mxids = ["MXid_A", "MXid_B"]
â”‚
â”œâ”€ 3. è‡ªåŠ¨åŒ¹é…
â”‚   â”œâ”€ LEFT_CAMERA.historical_mxids = ["MXid_A", "MXid_D"]
â”‚   â”œâ”€ å‘ç° MXid_A åœ¨çº¿
â”‚   â””â”€ LEFT_CAMERA.active_mxid = "MXid_A"
â”‚
â”œâ”€ 4. æ£€æŸ¥ä¸Šæ¬¡è®¾å¤‡
â”‚   â”œâ”€ last_active_mxid = "MXid_A"
â”‚   â”œâ”€ active_mxid = "MXid_A"
â”‚   â””â”€ âœ… è®¾å¤‡æœªåˆ‡æ¢
â”‚
â””â”€ 5. åŠ è½½åæ ‡å˜æ¢å‚æ•°
    â””â”€ coordinate_transforms[LEFT_CAMERA] â†’ ç›´æ¥ä½¿ç”¨
```

---

### è®¾å¤‡æ›´æ¢ï¼šæ— ç¼åˆ‡æ¢

```
åœºæ™¯ï¼šå·¦ç›¸æœºæŸåï¼Œæ›´æ¢ä¸ºæ–°è®¾å¤‡

æ­¥éª¤ï¼š
â”œâ”€ 1. ä½¿ç”¨è®¾å¤‡ç»‘å®šå·¥å…·
â”‚   â”œâ”€ æ‰«æåˆ°æ–°è®¾å¤‡ MXid_E
â”‚   â””â”€ ä¸º MXid_E é€‰æ‹© role = LEFT_CAMERA
â”‚
â”œâ”€ 2. ç³»ç»Ÿè‡ªåŠ¨å¤„ç†
â”‚   â”œâ”€ role_bindings[LEFT_CAMERA].historical_mxids.append("MXid_E")
â”‚   â””â”€ ç°åœ¨åˆ—è¡¨: ["MXid_A", "MXid_D", "MXid_E"]
â”‚
â”œâ”€ 3. å¯é€‰ï¼šç§»é™¤æ—§MXid
â”‚   â””â”€ ä» historical_mxids ä¸­åˆ é™¤ MXid_A
â”‚
â”œâ”€ 4. ä¸‹æ¬¡å¯åŠ¨
â”‚   â”œâ”€ åœ¨çº¿è®¾å¤‡: ["MXid_E", "MXid_B"]
â”‚   â”œâ”€ è‡ªåŠ¨è¯†åˆ« MXid_E â†’ LEFT_CAMERA
â”‚   â””â”€ åæ ‡å˜æ¢å‚æ•° â†’ ç›´æ¥ä½¿ç”¨ï¼ˆä¸éœ€è¦é‡æ–°æ ‡å®šï¼ï¼‰
â”‚
â””â”€ ç»“æœï¼šè®¾å¤‡æ›´æ¢ï¼Œ0 ä»£ç ä¿®æ”¹ï¼Œ0 å‚æ•°é‡æ–°æ ‡å®š
```

---

## ğŸ“Š é…ç½®æ–‡ä»¶ç¤ºä¾‹

```json
{
  "config_version": "2.0.0",
  
  "role_bindings": {
    "left_camera": {
      "role": "left_camera",
      "historical_mxids": ["14442C10D13D0D0000", "14442C10D13D0D0001"],
      "active_mxid": null,
      "last_active_mxid": "14442C10D13D0D0000"
    },
    "right_camera": {
      "role": "right_camera",
      "historical_mxids": ["14442C10D13D0D0002"],
      "active_mxid": null,
      "last_active_mxid": "14442C10D13D0D0002"
    }
  },
  
  "device_metadata": {
    "14442C10D13D0D0000": {
      "mxid": "14442C10D13D0D0000",
      "notes": "2025å¹´10æœˆè´­å…¥ï¼Œä¸»åŠ›è®¾å¤‡",
      "device_type": "OAK-D",
      "first_seen": 1696780800.0,
      "last_seen": 1696867200.0,
      "health_status": "good"
    }
  },
  
  "coordinate_transforms": {
    "left_camera": {
      "role": "left_camera",
      "translation": [100.0, 50.0, 200.0],
      "rotation": [0.0, 0.0, 45.0],
      "scale": 1.0,
      "calibration_date": "2025-10-08",
      "calibration_method": "manual",
      "calibration_accuracy": 2.5
    }
  }
}
```

---

## âœ… è®¾è®¡ä¼˜åŠ¿

1. **è®¾å¤‡çƒ­æ’æ‹”** - è®°ä½å†å²MXidï¼Œè‡ªåŠ¨è¯†åˆ«
2. **é…ç½®æŒä¹…åŒ–** - åæ ‡å˜æ¢ç­‰å‚æ•°ç»‘å®šåˆ°è§’è‰²ï¼Œè®¾å¤‡æ›´æ¢ä¸ä¸¢å¤±
3. **ç»´æŠ¤ç®€å•** - å¤‡æ³¨è®°å½•åœ¨è®¾å¤‡çº§åˆ«ï¼Œæ–¹ä¾¿è¿½è¸ª
4. **ç±»å‹å®‰å…¨** - ä½¿ç”¨æšä¸¾é¿å…æ‹¼å†™é”™è¯¯
5. **æ˜“äºæ‰©å±•** - æ·»åŠ æ–°è§’è‰²åªéœ€ä¿®æ”¹æšä¸¾

---

## âœ… ç¡®è®¤çš„è®¾è®¡å†³ç­–

### 1. `historical_mxids` ç®¡ç†ç­–ç•¥

**å†³ç­–**ï¼šé™åˆ¶æœ€å¤§æ•°é‡ä¸º5ä¸ª

```python
MAX_HISTORICAL_MXIDS = 5

# æ·»åŠ æ–°MXidæ—¶
if mxid not in binding.historical_mxids:
    binding.historical_mxids.append(mxid)
    # è¶…å‡ºé™åˆ¶ï¼Œåˆ é™¤æœ€æ—§çš„
    if len(binding.historical_mxids) > MAX_HISTORICAL_MXIDS:
        binding.historical_mxids.pop(0)
```

**åŸå› **ï¼š5ä¸ªè®¾å¤‡è¶³å¤Ÿè®°å½•è®¾å¤‡æ›´æ¢å†å²ï¼Œé¿å…åˆ—è¡¨æ— é™å¢é•¿

---

### 2. å¤šè®¾å¤‡å†²çªå¤„ç†ç­–ç•¥

**åœºæ™¯**ï¼šå¯åŠ¨æ—¶å‘ç°å¤šä¸ªå†å²MXidéƒ½åœ¨çº¿

```python
LEFT_CAMERA.historical_mxids = ["MXid_A", "MXid_B", "MXid_C"]
LEFT_CAMERA.last_active_mxid = "MXid_B"
åœ¨çº¿è®¾å¤‡ = ["MXid_A", "MXid_B", "MXid_C"]  # å¤šä¸ªéƒ½åœ¨çº¿
```

**å†³ç­–**ï¼šä¼˜å…ˆé€‰æ‹© `last_active_mxid`ï¼ˆå¦‚æœåœ¨çº¿ï¼‰

```python
def match_device_for_role(binding: DeviceRoleBindingDTO, online_mxids: List[str]) -> Optional[str]:
    """ä¸ºè§’è‰²åŒ¹é…è®¾å¤‡"""
    
    # 1. ä¼˜å…ˆé€‰æ‹©ä¸Šæ¬¡ä½¿ç”¨çš„è®¾å¤‡
    if binding.last_active_mxid and binding.last_active_mxid in online_mxids:
        return binding.last_active_mxid
    
    # 2. å¦åˆ™é€‰æ‹©å†å²åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªåœ¨çº¿çš„
    for mxid in binding.historical_mxids:
        if mxid in online_mxids:
            return mxid
    
    # 3. æ²¡æœ‰åŒ¹é…çš„è®¾å¤‡
    return None
```

---

### 3. æœªåŒ¹é…åˆ°è®¾å¤‡çš„å¤„ç†

**åœºæ™¯1**ï¼šæŸä¸ªroleæ²¡æœ‰åŒ¹é…åˆ°åœ¨çº¿è®¾å¤‡

```
å¯åŠ¨æ£€æŸ¥ï¼š
â”œâ”€ LEFT_CAMERA: âœ… å·²åŒ¹é… MXid_A
â”œâ”€ RIGHT_CAMERA: âŒ æœªåŒ¹é…åˆ°è®¾å¤‡
â””â”€ ç³»ç»Ÿæç¤º:
    
    âš ï¸ è­¦å‘Šï¼šè§’è‰² 'RIGHT_CAMERA' æœªåŒ¹é…åˆ°åœ¨çº¿è®¾å¤‡
    
    é€‰é¡¹ï¼š
    1. è¿”å›è®¾å¤‡ç»‘å®šå·¥å…·ï¼Œä¸ºè¯¥è§’è‰²ç»‘å®šæ–°è®¾å¤‡
    2. ä»…å¯åŠ¨å·²åŒ¹é…çš„è®¾å¤‡ï¼ˆå•ç›¸æœºæ¨¡å¼ï¼‰
    3. é€€å‡ºç³»ç»Ÿ
    
    è¯·é€‰æ‹© [1/2/3]:
```

**å¤„ç†ç­–ç•¥**ï¼š
- **äº¤äº’å¼å¯åŠ¨**ï¼ˆæœ‰ç•Œé¢ï¼‰ï¼šæç¤ºç”¨æˆ·é€‰æ‹©
- **è‡ªåŠ¨å¯åŠ¨**ï¼ˆåå°æœåŠ¡ï¼‰ï¼šè‡ªåŠ¨é€‰æ‹©å•ç›¸æœºæ¨¡å¼ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—

---

### 4. åæ ‡å˜æ¢å‚æ•°è®¾è®¡

**å†³ç­–**ï¼šä½¿ç”¨åˆ†ç¦»çš„å¹³ç§»ã€åèˆªã€ä¿¯ä»°å‚æ•°

```python
@dataclass
class CoordinateTransformConfigDTO(BaseDTO):
    """åæ ‡å˜æ¢é…ç½®"""
    
    role: DeviceRole                          # åŠŸèƒ½è§’è‰²
    
    # å˜æ¢å‚æ•°ï¼ˆæ¬§æ‹‰è§’è¡¨ç¤ºï¼‰
    translation_x: float = 0.0                # å¹³ç§» X (mm)
    translation_y: float = 0.0                # å¹³ç§» Y (mm)
    translation_z: float = 0.0                # å¹³ç§» Z (mm)
    
    roll: float = 0.0                         # ç¿»æ»šè§’ (åº¦) - æš‚ä¸ä½¿ç”¨
    pitch: float = 0.0                        # ä¿¯ä»°è§’ (åº¦)
    yaw: float = 0.0                          # åèˆªè§’ (åº¦)
    
    # æ ‡å®šä¿¡æ¯
    calibration_date: Optional[str] = None
    calibration_method: Optional[str] = None  # "manual" / "auto"
    calibration_accuracy: Optional[float] = None  # ç²¾åº¦ (mm)
    
    def get_transform_matrix(self) -> np.ndarray:
        """
        ç”Ÿæˆ4x4å˜æ¢çŸ©é˜µ
        
        Returns:
            4x4çš„é½æ¬¡å˜æ¢çŸ©é˜µ
        """
        import numpy as np
        
        # å°†è§’åº¦è½¬æ¢ä¸ºå¼§åº¦
        pitch_rad = np.radians(self.pitch)
        yaw_rad = np.radians(self.yaw)
        roll_rad = np.radians(self.roll)
        
        # æ„å»ºæ—‹è½¬çŸ©é˜µï¼ˆZYXé¡ºåºï¼‰
        # Yaw (Zè½´æ—‹è½¬)
        Rz = np.array([
            [np.cos(yaw_rad), -np.sin(yaw_rad), 0],
            [np.sin(yaw_rad),  np.cos(yaw_rad), 0],
            [0,                0,               1]
        ])
        
        # Pitch (Yè½´æ—‹è½¬)
        Ry = np.array([
            [ np.cos(pitch_rad), 0, np.sin(pitch_rad)],
            [ 0,                 1, 0                ],
            [-np.sin(pitch_rad), 0, np.cos(pitch_rad)]
        ])
        
        # Roll (Xè½´æ—‹è½¬)
        Rx = np.array([
            [1, 0,                 0                ],
            [0, np.cos(roll_rad), -np.sin(roll_rad)],
            [0, np.sin(roll_rad),  np.cos(roll_rad)]
        ])
        
        # ç»„åˆæ—‹è½¬çŸ©é˜µ
        R = Rz @ Ry @ Rx
        
        # æ„å»º4x4é½æ¬¡å˜æ¢çŸ©é˜µ
        T = np.eye(4)
        T[0:3, 0:3] = R
        T[0:3, 3] = [self.translation_x, self.translation_y, self.translation_z]
        
        return T
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
# é…ç½®å‚æ•°
transform_config = CoordinateTransformConfigDTO(
    role=DeviceRole.LEFT_CAMERA,
    translation_x=100.0,
    translation_y=50.0,
    translation_z=200.0,
    pitch=10.0,
    yaw=45.0
)

# è·å–å˜æ¢çŸ©é˜µ
T = transform_config.get_transform_matrix()

# åº”ç”¨å˜æ¢
camera_point = np.array([x, y, z, 1])  # é½æ¬¡åæ ‡
world_point = T @ camera_point
```

---

### 5. å¤‡æ³¨å­—æ®µä½ç½®

**ç¡®è®¤**ï¼šå¤‡æ³¨åœ¨ `DeviceMetadataDTO` ä¸­ï¼ˆæŒ‰MXidç´¢å¼•ï¼‰

**åŸå› **ï¼šå¤‡æ³¨æè¿°çš„æ˜¯ç‰©ç†è®¾å¤‡æœ¬èº«ï¼Œè€Œä¸æ˜¯åŠŸèƒ½ä½ç½®

---

## ğŸ¯ å®ç°è¦ç‚¹æ€»ç»“

### è®¾å¤‡åŒ¹é…ç®—æ³•ï¼ˆæ ¸å¿ƒï¼‰

```python
class DeviceMatchResult:
    """è®¾å¤‡åŒ¹é…ç»“æœ"""
    matched_roles: Dict[DeviceRole, str]      # æˆåŠŸåŒ¹é…çš„è§’è‰²
    unmatched_roles: List[DeviceRole]         # æœªåŒ¹é…çš„è§’è‰²
    warnings: List[str]                       # è­¦å‘Šä¿¡æ¯

def match_devices(
    role_bindings: Dict[DeviceRole, DeviceRoleBindingDTO],
    online_mxids: List[str]
) -> DeviceMatchResult:
    """
    è®¾å¤‡åŒ¹é…ç®—æ³•
    
    Args:
        role_bindings: æ‰€æœ‰è§’è‰²çš„ç»‘å®šé…ç½®
        online_mxids: å½“å‰åœ¨çº¿çš„MXidåˆ—è¡¨
        
    Returns:
        DeviceMatchResult: åŒ¹é…ç»“æœ
    """
    result = DeviceMatchResult()
    
    for role, binding in role_bindings.items():
        # 1. ä¼˜å…ˆé€‰æ‹©ä¸Šæ¬¡ä½¿ç”¨çš„è®¾å¤‡
        if binding.last_active_mxid and binding.last_active_mxid in online_mxids:
            matched_mxid = binding.last_active_mxid
            result.matched_roles[role] = matched_mxid
            continue
        
        # 2. å¦åˆ™é€‰æ‹©å†å²åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªåœ¨çº¿çš„
        matched = False
        for mxid in binding.historical_mxids:
            if mxid in online_mxids:
                matched_mxid = mxid
                result.matched_roles[role] = matched_mxid
                matched = True
                
                # å¦‚æœåŒ¹é…çš„ä¸æ˜¯ä¸Šæ¬¡ä½¿ç”¨çš„è®¾å¤‡ï¼Œè®°å½•è­¦å‘Š
                if binding.last_active_mxid and matched_mxid != binding.last_active_mxid:
                    result.warnings.append(
                        f"è§’è‰² '{role.value}' åˆ‡æ¢è®¾å¤‡: "
                        f"{binding.last_active_mxid[-8:]} â†’ {matched_mxid[-8:]}"
                    )
                break
        
        # 3. æ²¡æœ‰åŒ¹é…çš„è®¾å¤‡
        if not matched:
            result.unmatched_roles.append(role)
            result.warnings.append(f"è§’è‰² '{role.value}' æœªåŒ¹é…åˆ°åœ¨çº¿è®¾å¤‡")
    
    return result
```

### historical_mxids æ¸…ç†ç­–ç•¥

```python
MAX_HISTORICAL_MXIDS = 5

def add_mxid_to_history(binding: DeviceRoleBindingDTO, mxid: str) -> None:
    """æ·»åŠ MXidåˆ°å†å²åˆ—è¡¨ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰"""
    
    # å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤ï¼ˆç„¶åä¼šæ·»åŠ åˆ°æœ«å°¾ï¼‰
    if mxid in binding.historical_mxids:
        binding.historical_mxids.remove(mxid)
    
    # æ·»åŠ åˆ°æœ«å°¾
    binding.historical_mxids.append(mxid)
    
    # è¶…å‡ºé™åˆ¶ï¼Œåˆ é™¤æœ€æ—§çš„ï¼ˆç¬¬ä¸€ä¸ªï¼‰
    while len(binding.historical_mxids) > MAX_HISTORICAL_MXIDS:
        removed = binding.historical_mxids.pop(0)
        logger.info(f"è§’è‰² '{binding.role.value}' æ¸…ç†æ—§è®¾å¤‡: {removed[-8:]}")
```

### å¯åŠ¨æµç¨‹å®Œæ•´ç¤ºä¾‹

```python
def system_startup():
    """ç³»ç»Ÿå¯åŠ¨æµç¨‹"""
    
    # 1. åŠ è½½é…ç½®
    config = config_manager.load_config()
    
    # 2. æ‰«æåœ¨çº¿è®¾å¤‡
    online_mxids = dai.DeviceBootloader.getAllAvailableDevices()
    logger.info(f"æ£€æµ‹åˆ° {len(online_mxids)} ä¸ªåœ¨çº¿è®¾å¤‡")
    
    # 3. è®¾å¤‡åŒ¹é…
    match_result = match_devices(config.role_bindings, online_mxids)
    
    # 4. å¤„ç†åŒ¹é…ç»“æœ
    if match_result.unmatched_roles:
        logger.warning("ä»¥ä¸‹è§’è‰²æœªåŒ¹é…åˆ°è®¾å¤‡:")
        for role in match_result.unmatched_roles:
            logger.warning(f"  - {role.value}")
        
        # æç¤ºç”¨æˆ·é€‰æ‹©
        if is_interactive_mode():
            choice = prompt_user_choice(
                "é€‰æ‹©æ“ä½œ: [1]ç»‘å®šæ–°è®¾å¤‡ [2]å•ç›¸æœºå¯åŠ¨ [3]é€€å‡º",
                valid_choices=["1", "2", "3"]
            )
            if choice == "1":
                run_device_binding_tool()
                return
            elif choice == "3":
                sys.exit(0)
            # choice == "2" ç»§ç»­å•ç›¸æœºå¯åŠ¨
        else:
            # è‡ªåŠ¨å¯åŠ¨æ¨¡å¼ï¼Œé€‰æ‹©å•ç›¸æœº
            logger.warning("è‡ªåŠ¨å¯åŠ¨ï¼šä½¿ç”¨å•ç›¸æœºæ¨¡å¼")
    
    # 5. æ¿€æ´»åŒ¹é…çš„è®¾å¤‡
    for role, mxid in match_result.matched_roles.items():
        binding = config.role_bindings[role]
        binding.active_mxid = mxid
        logger.info(f"âœ… {role.value} â†’ {mxid[-8:]}")
    
    # 6. æ›´æ–° last_active_mxid å¹¶ä¿å­˜
    for role, binding in config.role_bindings.items():
        if binding.active_mxid:
            binding.last_active_mxid = binding.active_mxid
    
    config_manager.save_config()
    
    # 7. å¯åŠ¨ç³»ç»Ÿ
    start_vision_system(match_result.matched_roles)
```

---

## ğŸ“ ä¸‹ä¸€æ­¥å¼€å‘ä»»åŠ¡

### é˜¶æ®µ1ï¼šDTOé‡æ„ï¼ˆå¾…å‘½ä»¤æ‰§è¡Œï¼‰

- [ ] åˆ é™¤æ—§çš„ `AliasBindingDTO`ã€`AliasHistoryDTO`ã€`AliasManagerConfigDTO`
- [ ] åˆ›å»ºæ–°çš„ `DeviceRole` æšä¸¾
- [ ] åˆ›å»ºæ–°çš„ `DeviceRoleBindingDTO`
- [ ] åˆ›å»ºæ–°çš„ `DeviceMetadataDTO`
- [ ] åˆ›å»ºæ–°çš„ `CoordinateTransformConfigDTO`
- [ ] æ›´æ–° `DeviceManagerConfigDTO`
- [ ] æ›´æ–°ç›¸å…³çš„ `from_dict` å’Œåºåˆ—åŒ–æ–¹æ³•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

### é˜¶æ®µ2ï¼šè®¾å¤‡åŒ¹é…ç®¡ç†å™¨

- [ ] å®ç° `DeviceMatchManager` ç±»
- [ ] å®ç°è®¾å¤‡åŒ¹é…ç®—æ³•
- [ ] å®ç° historical_mxids æ¸…ç†ç­–ç•¥
- [ ] å®ç°å¯åŠ¨æµç¨‹é›†æˆ
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

### é˜¶æ®µ3ï¼šé…ç½®ç®¡ç†å™¨æ›´æ–°

- [ ] æ›´æ–° `SystemConfigManager` ä»¥æ”¯æŒæ–°çš„DTOç»“æ„
- [ ] å®ç°é…ç½®æ–‡ä»¶è¿ç§»å·¥å…·ï¼ˆä»æ—§æ ¼å¼åˆ°æ–°æ ¼å¼ï¼‰
- [ ] æ›´æ–°é…ç½®åŠ è½½å’Œä¿å­˜é€»è¾‘
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

### é˜¶æ®µ4ï¼šè®¾å¤‡ç»‘å®šå·¥å…·ï¼ˆCLIï¼‰

- [ ] å®ç°è®¾å¤‡å‘ç°åŠŸèƒ½
- [ ] å®ç°è®¾å¤‡é¢„è§ˆåŠŸèƒ½
- [ ] å®ç°è§’è‰²ç»‘å®šåŠŸèƒ½
- [ ] å®ç°å¤‡æ³¨ç¼–è¾‘åŠŸèƒ½
- [ ] ç¼–å†™ä½¿ç”¨æ–‡æ¡£

---

## âœ… æ¶æ„è®¾è®¡å·²ç¡®è®¤

æ‰€æœ‰å…³é”®è®¾è®¡å†³ç­–å·²ç¡®è®¤ï¼š
- âœ… Role ä½œä¸ºä¸»é”®ï¼Œä½¿ç”¨æšä¸¾
- âœ… historical_mxids é™åˆ¶ä¸º5ä¸ªï¼Œè‡ªåŠ¨æ¸…ç†
- âœ… å¤šè®¾å¤‡å†²çªï¼šä¼˜å…ˆé€‰æ‹© last_active_mxid
- âœ… æœªåŒ¹é…è®¾å¤‡ï¼šæ”¯æŒå•ç›¸æœºå¯åŠ¨
- âœ… åæ ‡å˜æ¢ï¼šä½¿ç”¨å¹³ç§»+ä¿¯ä»°+åèˆªï¼Œç”Ÿæˆ4x4çŸ©é˜µ
- âœ… å¤‡æ³¨ä¿¡æ¯ï¼šå­˜å‚¨åœ¨ DeviceMetadataDTOï¼ˆæŒ‰MXidï¼‰

**ç­‰å¾…å‘½ä»¤å¼€å§‹DTOé‡æ„ï¼** ğŸš€
