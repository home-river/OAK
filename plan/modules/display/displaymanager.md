# 显示模块设计

显示模块接收collector发布的视频帧数据，接收data_processor发布的处理过后的数据帧数据，并提供cv的绘图功能。


## 打包模块

作为显示模块的输入端，负责将上游模块的数据进行打包，并整理成标准格式提供给显示模块。

**要点**：
1. 数据接收与缓存

- 接收外部输入的视频帧（图像、帧ID、时间戳）
- 接收外部输入的检测数据（检测结果、帧ID、时间戳）
- 分设备独立缓存最新数据

2. 帧同步匹配

- 基于帧ID严格匹配视频帧和检测数据
- 识别数据齐备的帧（视频帧和检测数据帧ID相等）
- 处理数据乱序到达的情况

3. 数据规范化

- 将匹配成功的数据组装成统一的RenderPacket结构
- 标准化数据格式供渲染模块使用
- 附加元数据（时间戳、设备ID等）

4. 队列管理

- 将打包好的数据放入有界队列
- 队列满时执行丢弃策略（丢弃最旧数据包）
- 供阻塞式的get()接口供主循环获取

5. 缓存清理

- 防止内存无限增长，限制最大缓存容量
- 清理超时或过期的未匹配数据
- 处理帧ID溢出等边界情况

6. 颜色方案映射
- 采用字典的方式管理映射方案，提升查找效率
- 映射的key等待确认数据处理模块的传出DTO再确定


## 渲染模块

接收打包后的固定格式的数据结构，然后绘制图像，并提供个性化的识别框标注功能。

可能的功能：

- labels和状态标签到检测框颜色的映射管理
- 统一HUD管线
- 布局和显示模式的切换
- 轻开销的性能监控（可选）
- 文本叠加

### labels和状态标签到检测框颜色的映射管理

- 固定映射与动态策略：label→color（可配置）；按置信度/距离渐变，保证可区分性。
- 回退与可读性：未配置时使用默认调色板；提供色盲友好配色方案（可选）。
- 可扩展：可插拔映射器；生成图例/示意（可选）。

### 统一HUD管线

- Overlay 顺序：device_info → fps/frame_id → help_text → debug（可配置）。
- 开关控制：show_device_info/show_fps/show_coords/show_labels/show_confidence 等。
- 文本样式：字体、字号比例、描边/底框、边距与安全区，避免遮挡关键区域。
- 单位与格式：mm/px，小数位格式化与本地化占位文本。

### 布局和显示模式的切换

- 模式：rgb/depth/combined/side_by_side/overlay（叠加或并排）。
- 多设备：水平/垂直/网格拼接；支持 tile_size 与子画面标题（设备名）。
- 尺寸策略：默认等比缩放+letterbox；可选拉伸；分隔线与边距（可选）。
- 对齐规则：叠加元素在缩放后自适配；深度与彩色坐标系对齐与偏移处理。

### 轻开销的性能监控（可选）

- 统计项：总耗时与分阶段耗时（归一化/伪彩/叠加/拼接）、对象/文本数量。
- 采样策略：滑动平均/分位数，采样频率可配置；禁用时零开销。
- 暴露方式：HUD 简报或日志输出（与系统日志策略一致）。
- 性能目标：典型监控开销 < 1ms，不阻塞主路径。

### 文本叠加

- 通用API：锚点（left/top）、行距、自动换行（可选）、对齐方式（左/中/右）。
- 语义组件：标签+置信度、三维坐标(mm)、设备名、模式、帮助提示、帧号/时间戳。
- 可读性：描边/底框、对比度检查、颜色主题；超界裁剪与 Unicode 兼容。
- 数值格式：置信度百分比/小数位、坐标单位与格式模板可配置。

---

当前渲染包结构（草案）：
`RenderPacket = { video_frame: VideoFrameDTO, processed_detections: List[DeviceProcessedDetectionDTO] }`，
打包模块按设备+frame_id 同步缓存 `VideoFrameDTO` 与 `DeviceProcessedDetectionDTO`，
匹配成功后输出该结构供渲染模块直接消费。


-------
