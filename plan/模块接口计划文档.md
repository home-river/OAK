# 数据契约与DTO定义

##  设计总览


### DTO设计总览
本节按“每个 DTO 一个小标题”的方式，列出核心字段与自带功能接口，便于跨模块对齐契约。

####  BaseDTO（基类）
- 字段：version, created_at, is_valid, validation_errors
- 方法：validate()；to_dict()/to_json()；from_dict()/from_json()；with_updates(**changes)

#### BaseConfigDTO（配置基类）
- 说明：面向配置持久化，复用 BaseDTO 的序列化/反序列化；其余语义同 BaseDTO

#### DeviceMetadataDTO
- 描述：按 MXID 索引的物理设备元信息，用于识别与状态展示。
- 字段：
  - mxid: str（主键，设备唯一标识）
  - product_name: str|None（产品名称，可能通过设备读取）
  - connection_status: ConnectionStatus（CONNECTED/DISCONNECTED/UNKNOWN）
  - notes: str|None（备注）
  - first_seen/last_seen: float（首次/最近发现时间）
- 方法：
  - validate(): 长度/枚举合法性校验

#### DeviceRoleBindingDTO
- 描述：记录“功能角色 ↔ 设备历史/当前”的绑定关系，支持自动识别与手动调整。
- 字段：
  - role: DeviceRole（LEFT_CAMERA/RIGHT_CAMERA）
  - historical_mxids: List[str]（历史 MXID，最多 5 个）
  - active_mxid: str|None（当前激活 MXID，运行时）
  - last_active_mxid: str|None（上次使用的 MXID，持久化）
- 方法：
  - has_active_device: bool（是否存在 active_mxid）
  - add_mxid_to_history(mxid): 添加新 MXID（去重/LIFO/自动截断至 5）
  - remove_mxid_from_history(mxid): 从历史中移除（同时清理 active/last_active）
  - set_active_Mxid_by_device(device: DeviceMetadataDTO): 用设备 MXID 更新 active/last_active，并维护历史
  - get_history_count(): int（历史数量）
  - is_mxid_in_history(mxid): bool

#### OAKConfigDTO
- 描述：DepthAI 模型/相机/深度/队列等硬件侧参数。
- 字段：
  - 模型：model_path, label_map, num_classes, confidence_threshold, nms_threshold, max_detections
  - 相机：rgb_resolution, preview_resolution, hardware_fps, usb2_mode
  - 深度：enable_depth_output, depth_resolution, depth_min_threshold, depth_max_threshold, align_depth_to_rgb, median_filter(3/5/7), left_right_check, extended_disparity, subpixel
  - 队列：queue_max_size, queue_blocking
- 方法：
  - validate(): 路径/范围/阈值/集合合法性校验

#### OAKModuleConfigDTO
- 描述：聚合 OAK 硬件配置与设备绑定/元数据，并提供便捷查询接口。
- 字段：
  - hardware_config: OAKConfigDTO
  - role_bindings: Dict[DeviceRole, DeviceRoleBindingDTO]
  - device_metadata: Dict[str, DeviceMetadataDTO]
- 方法：
  - get_role_binding(role) → DeviceRoleBindingDTO|None
  - get_active_mxid(role) → str|None
  - get_device_metadata(mxid) → DeviceMetadataDTO|None
  - has_role(role) → bool；has_active_device(role) → bool
  - active_role_count/total_role_count/available_roles
  - get_summary() → str（人类可读摘要）

#### DeviceManagerConfigDTO
- 描述：整合 OAK 模块、数据处理、CAN、显示、系统配置的顶级 DTO。
- 字段：config_version；oak_module；data_processing_config；can_config；display_config；system_config
- 方法：
  - 委托 OAK：get_active_mxid(role)、get_device_metadata(mxid)、has_active_device(role)、active_role_count
  - get_summary() → str（全局摘要）

#### CoordinateTransformConfigDTO
- 描述：按角色存储 3 平移 + 3 欧拉角（度）的位姿参数，绑定角色而非设备。
- 字段：role；translation_x/y/z；roll/pitch/yaw；calibration_date?；calibration_method?(manual/auto)
- 方法：validate()（枚举/标定元校验）

#### MovingAverageFilterConfigDTO
- 描述：简单稳定的平滑滤波。
- 字段：window_size（>=1，建议 ≤50）；weighted（是否加权）
- 方法：validate()

#### KalmanFilterConfigDTO
- 描述：线性高斯假设下的递推滤波。
- 字段：kalman_gain(0..1)；process_noise(0..10)；measurement_noise(0..10)
- 方法：validate()

#### LowpassFilterConfigDTO
- 描述：一阶低通的截止频率设定。
- 字段：cutoff_frequency(0.1..100.0)
- 方法：validate()

#### MedianFilterConfigDTO
- 描述：抗脉冲噪声，要求奇数窗口。
- 字段：window_size（>=3 且为奇数）
- 方法：validate()

#### FilterConfigDTO 
- 描述：通过 filter_type 切换具体滤波器配置；保证选中类型的配置存在。
- 字段：filter_type；moving_average_config?；kalman_config?；lowpass_config?；median_config?
- 方法：get_active_filter_config()；validate()

#### DataProcessingConfigDTO
- 描述：汇总坐标变换与滤波配置，并提供便捷访问。
- 字段：coordinate_transforms: Dict[DeviceRole, CoordinateTransformConfigDTO]；filter_config；enable_data_logging；processing_thread_priority；person_timeout_seconds
- 方法：validate()；get_coordinate_transform(role)；add_coordinate_transform(config)

#### DisplayConfigDTO
- 描述：窗口/渲染/叠加/深度显示样式与参数。
- 字段：
  - 总开关：enable_display
  - 模式：default_display_mode("rgb/depth/combined/side_by_side")；fullscreen（未实现，实际字段名：enable_fullscreen）；window_width/height；window_position_x/y
  - 渲染：target_fps；enable_vsync
  - 叠加：show_detection_boxes/labels/confidence/coordinates/fps/device_info
  - 深度显示：depth_colormap(JET/…)；depth_alpha(0..1)；normalize_depth
  - 样式：bbox_thickness；bbox_color_by_label；text_scale
- 方法：validate()

#### SystemConfigDTO
- 描述：日志/性能/系统行为/数据采集的应用层配置。
- 字段：
  - 日志：log_level；log_to_file；log_file_path；
    log_rotate_mode(time/size)；log_rotate_when；log_rotate_interval；log_rotate_utc；
    log_max_size_mb（仅size模式生效）；log_backup_count（size模式为备份数，time模式为保留天数，默认7）
  - 性能：enable_profiling；max_worker_threads；enable_gpu_acceleration
  - 行为：auto_reconnect；reconnect_interval；max_reconnect_attempts；graceful_shutdown_timeout
  - 采集：enable_data_recording；recording_output_dir；recording_format(hdf5/csv/json/pickle)
- 方法：validate()

#### CanFrameMeta
- 字段：frame_id（十进制 int）、is_extended（标准/扩展帧）、comment

#### FrameIdConfigDTO
- 描述：语义名称 → 帧元信息 的映射与合法性校验。
- 字段：frames: Dict[str, CanFrameMeta]
- 方法：validate()（ID 范围/唯一性/备注长度）

#### CANConfigDTO
- 描述：CAN 接口/通道/波特率/收发超时与帧 ID 配置。
- 字段：enable_can；can_interface；can_channel；can_bitrate；send_timeout_ms；receive_timeout_ms；frame_ids: FrameIdConfigDTO
- 方法：validate()（波特率/字符串/帧 ID 级联校验）

#### SpatialCoordinatesDTO
- 描述：以毫米为单位的三维坐标与便捷距离运算。
- 字段：x；y；z（float）
- 方法：distance_from_origin；distance_squared_from_origin；distance_to(other)；distance_squared_to(other)

#### BoundingBoxDTO
- 描述：像素系下的矩形框，提供几何便捷属性。
- 字段：xmin；ymin；xmax；ymax（float）
- 属性/方法：width；height；area；center_x；center_y；center_point；validate()

#### DetectionDTO
- 描述：单目标检测输出（标签/置信度/框/空间坐标），自动生成稳定 `detection_id`。
- 字段：label；confidence(0..1)；bbox: BoundingBoxDTO；spatial_coordinates: SpatialCoordinatesDTO；detection_id?
- 方法：validate()；构造后若 detection_id 缺失则基于 created_at+UUID 生成

#### DeviceDetectionDataDTO
- 描述：单设备在某帧的检测聚合与便捷查询。
- 字段：device_id；frame_id；device_alias?；detections?: List[DetectionDTO]
- 属性/方法：detection_count；get_detections_by_label(label)；get_high_confidence_detections(threshold)；get_detection_by_id(id)

#### VideoFrameDTO
- 描述：RGB/Depth 帧及其尺寸元数据，便于管线间传递。
- 字段：device_id；frame_id；rgb_frame?；depth_frame?；frame_width?；frame_height?
- 属性/方法：has_rgb；has_depth；frame_size

#### OAKDataCollectionDTO
- 描述：按批次聚合“设备检测数据 + 视频帧”，提供统计/查询。
- 字段：collection_id；devices_data?: Dict[str, DeviceDetectionDataDTO]；video_frames?: Dict[str, VideoFrameDTO]
- 属性/方法：available_devices；total_detections；get_device_data(device_id)；get_video_frame(device_id)；has_device_data(device_id)

#### RawFrameDataEvent
- 描述：通过事件总线发布的“原始帧”事件载荷。
- 字段：event_type="raw_frame_data"；device_id；video_frame?: VideoFrameDTO
- 方法：validate()

#### RawDetectionDataEvent
- 描述：通过事件总线发布的“原始检测数据”事件载荷。
- 字段：event_type="raw_detection_data"；device_id；detection_data?: DeviceDetectionDataDTO
- 方法：validate()



## 模块功能总览

### 核心DTO与数据契约（core/dto）
- 需要完成的功能：
  - 定义字段与类型，保持不可变性（dataclass frozen）。
  - 明确验证接口：手动 validate，支持嵌套对象级联校验与错误汇总。
  - 序列化/反序列化：to_dict/from_dict、to_json/from_json，支持枚举/容器/Optional/嵌套。
  - 版本与最小兼容：保留 version 字段，允许字段弃用标记（文档层面）。
  - 不可变更新：with_updates（浅层字段更新，用于配置更新）。
  - 运行时零开销：默认不自动验证，需要时按需调用 validate。

### 事件总线（core/event_bus）
- 需要完成的功能：
  - 定义事件类型与订阅接口；提供发布/订阅、同步/异步派发能力。
  - 作为模块解耦的数据通道，承载 RawFrameDataEvent / RawDetectionDataEvent。
  - 订阅生命周期管理、简单统计与诊断（可选背压/缓冲策略）。

### 配置管理（modules/config_manager）
- 需要完成的功能：
  - 设备发现（扫描/元数据采集）（已实现）；重连策略：手动重启系统触发重新扫描（自动重连未实现）。
  - 设备与角色匹配策略（历史 MXID、别名/手动绑定、优先级）。
  - 生成与持久化 DeviceManagerConfigDTO（加载/保存/迁移/版本兼容）。
  - 冲突检测与提示（多设备竞争、缺失设备）。

### 数据采集（modules/data_collector）
- 需要完成的功能：
  - 接入 DepthAI 管线，采集 RGB/Depth 与检测结果。
  - 按帧同步，将数据帧和视频帧分别封装为 RawDetectionDataEvent 和 RawFrameDataEvent，通过事件总线分别发布：
    - 数据帧事件发送给数据处理模块；
    - 视频帧事件发送给显示模块。
  - 线程/进程安全的数据投递。

### 数据处理（modules/data_processing）
- 需要完成的功能：
  - 坐标变换：高效地对传入的坐标数据进行统一的坐标变换，输出变换后的坐标数据，支持快速修改坐标变换的参数。
  - 动态滤波：对目标坐标进行跟踪滤波，动态改变滤波器数量以匹配识别情况，输出滤波后的坐标数据。
  - 坐标修正：可选的误差修正与标定补偿，提升精度。
  - 决策判定：给出危险状态、可抓取性、优先级与抓取点。
  - 对外输出：向显示提供绘制所需数据，向 CAN 提供协议化指令。
  - 阶段二扩展：接入完整结构化数据驱动的运动控制决策。

### 显示（modules/display）
- 需要完成的功能：
  - 接收的数据：接受数据采集模块传来的视频帧，接收数据处理模块传来的坐标数据，决策数据
    并进行绘制检测框、标签、置信度、3D 坐标、FPS、设备信息、危险状态、可抓取性、优先级与抓取点绘制。
  - 渲染模式（当前采用）：完全异步——接收到视频帧即渲染；叠加始终取最近一次数据帧，不等待配对。
  - 叠加检测框、标签、置信度、3D 坐标、FPS、设备信息。
  - 深度伪彩映射、透明度与归一化；窗口模式与 enable_fullscreen。
  - 基础交互：是否开启深度图绘制、放大缩小。

### CAN 通信（modules/can）
- 需要完成的功能：
  - 总线监听：监听CAN总线，接收外部系统发送的数据和指令。
  - 数据发送：按照协议，将指定格式的数据发送给外部系统。
  - 配置修改：提供便捷的接口，修改CAN通信的配置。

### 工具与脚本（tools）
- 需要完成的功能：
  - 设备角色绑定工具（维护 DeviceRoleBindingDTO 与历史 MXID）。
  - 迁移/诊断/配置辅助脚本。

### 示例（examples）
- 需要完成的功能：
  - 覆盖配置加载、设备发现、事件流、显示与数据处理的端到端示例。
  - 最小示例与进阶组合用例。

### 测试（tests）
- 需要完成的功能：
  - 单元测试：DTO 校验、序列化、事件总线。
  - 集成测试：设备发现与匹配、配置生成与加载。
  - 冒烟测试：最小管线跑通（采集→事件→处理→显示）。


### 要点

1. 各个模块使用阻塞队列的形式获取数据，避免循环的空转造成性能开销。
2. 确认使用同步事件回调和阻塞队列的组合。



## 配置管理模块功能总览预案

### 设备发现（device_discovery.py）

  - 扫描/元数据采集
  - 返回设备元数据列表

### 设备匹配（device_match.py）

  - 设备匹配算法（历史 MXID、别名/手动绑定、优先级）。
  - OAK角色验证
  - 返回匹配结果
  - 自动重匹配功能
  - 匹配结果分析与验证

### 设备配置管理（device_config_manager.py）

  - 设备配置管理（加载/保存/迁移/版本兼容），生成与持久化 DeviceManagerConfigDTO。
  - 冲突检测与提示（多设备竞争、缺失设备）。
  - 

### 配置样板工具

- 从底层DTO到总体DTO的默认生成工具


---


## 数据处理模块功能总览预案

### 滤波器部分

滤波器的技术核心包括滤波算法和MOT方法

#### 滤波器设计
- 卡尔曼滤波
- 滑动平均滤波（暂时考虑这个）
- 指数移动平均滤波
- 中值滤波

#### MOT方法设计

1. 管理滤波器对象（Track/filter对象池）
  - 每个被追踪的目标2对应一个滤波器（内部维护滤波器状态）
  - 负责创建、更新、释放滤波器对象

2. 执行每帧的数据关联（匹配算法）
  - 输入：当前帧的检测结果（包含坐标、置信度等）
  - 维护：上一帧/历史的Track列表
  - 输出：带稳定ID+滤波后坐标的检测结果列表
3. 管理轨迹生命周期
  - 新目标：创建新的Track
  - 暂时丢失：记录未匹配计数
  - 长期丢失：释放对应的滤波器对象




#### **关键匹配方法设计方案**

##### **阶段一：基础版本（IoU 最近邻匹配）**

在系统开发初期，采用 **纯 IoU（Intersection over Union）最近邻匹配算法**。
该方案实现简单、计算开销低，可快速验证以下核心机制：

* **数据流完整性**：验证检测结果、跟踪对象（Track）及生命周期（创建 / 更新 / 删除）是否正确联动；
* **系统稳定性**：在轻量条件下跑通整条链路，确保事件总线、DTO、对象池等模块协同正常。

该阶段目标是：以最小实现成本快速获得可运行版本，为后续算法升级奠定结构基础。

---

##### **阶段二：可用版本（SORT 匹配方案）**

系统稳定后，升级至 **SORT（Simple Online and Realtime Tracking）风格算法**。
该方案在 IoU 基础上引入：

* **Kalman 滤波器**：对每个目标状态进行运动预测；
* **代价矩阵（Cost Matrix）**：使用 IoU 或中心点距离衡量预测框与检测框的匹配代价；
* **匈牙利算法（Hungarian Algorithm）**：实现全局最优匹配，提升匹配稳定性与多目标处理能力。

此阶段是性价比最高的版本，能够在保持实时性能的同时显著提升追踪精度和鲁棒性。

---

##### **阶段三：进阶版本（按需优化）**

在复杂场景下（如遮挡严重、目标密集或频繁 ID 交换），可基于现有架构选择针对性升级：

* **ByteTrack**：利用高低置信度检测结果优化匹配；
* **OC-SORT**：改进运动建模，提升遮挡与非线性运动下的稳定性；
* **DeepSORT**：引入外观特征（ReID 网络）辅助关联，减少 ID 错误切换。

推荐在明确性能瓶颈或应用场景需求后再引入此类方案，而非初期即全部实现。

---

##### **整体演进策略**

> **循序渐进、以稳定优先。**
> 从最简单的 IoU 匹配起步，逐步演进至 SORT，再根据应用需求选择更复杂的跟踪算法，以实现性能与开发成本的最佳平衡。

---


## 数据采集模块

分为pipelineManager和dataCollector

### pipelineManager
核心职责
封装 DepthAI Pipeline 创建逻辑
接收标准化配置 DTO
对外提供 Pipeline 实例

### dataCollector (OAKDataCollector)
核心职责

协调整个数据采集流程（主控制器）
管理设备连接与 Pipeline 生命周期
从 DepthAI 队列获取原始数据
将原始数据封装为标准 DTO
通过事件总线发布数据事件
