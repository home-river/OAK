# 背压控制方案（简洁总结）
---

### 核心思路

**利用事件总线实现解耦的背压控制，通过标志位让生产者自主控制速率。**

---

### 架构组成

#### 1️⃣ **背压监控模块**（独立线程）

* **职责**：周期性检查已注册队列的状态
* **输入**：通过 `register_queue()` 绑定需要观察的 `OverflowQueue`
* **逻辑**：

  * 读取队列指标（利用 `OverflowQueue` 的内置接口：`get_usage_ratio()`、`get_pressure_level()` 等）
  * 根据高低水位阈值决策是否需要背压（滞后逻辑避免抖动）
  * 状态变化时通过**事件总线**发布背压事件（`backpressure.triggered` / `backpressure.resumed`）

#### 2️⃣ **生产者端**（业务线程）

* **职责**：响应背压事件，动态调整生产速率
* **实现**：

  * 设计一个**标志位**（如 `production_mode`）表示当前速率模式
  * 订阅事件总线的背压事件
  * 在**事件回调**中使用**线程锁**安全地修改标志位
  * 在**生产循环**中读取标志位，根据模式控制行为：

    * `full_speed`：全速生产
    * `throttle`：间隔生产（降速）
    * `pause`：暂停生产

---

### 通信流程

```
背压监控线程 
  ↓ 检测到队列压力
  ↓ 发布事件到事件总线
事件总线
  ↓ 分发事件
生产者线程（回调函数）
  ↓ 加锁修改标志位
生产者线程（主循环）
  ↓ 读取标志位
  ↓ 根据标志位调整速率
```

---

### 关键特点

* ✅ **解耦彻底**：监控和生产者通过事件总线通信，互不依赖
* ✅ **简洁直接**：无需额外的协议层、适配器层
* ✅ **灵活控制**：支持多级速率控制（暂停/降速/全速）
* ✅ **利用现有基础设施**：复用事件总线，减少重复建设
* ✅ **线程安全**：标志位通过锁保护，回调快速返回
* ✅ **易扩展**：可以有多个订阅者响应同一个背压事件

---

### 一句话总结

**背压监控线程检测队列状态并发布事件，生产者订阅事件并通过标志位自主控制生产速率。**

---

## 四、代码落地规划（文件划分 + TODO 列表）

### 4.1 文件/模块划分（建议）

- `oak_vision_system/core/backpressure/__init__.py`
  - 导出 BackpressureMonitor、BackpressureConfig、BackpressureEventPayload 等类型。
- `oak_vision_system/core/backpressure/config.py`
  - 配置与阈值：`poll_interval_ms`、`high_ratio`、`low_ratio`、`drop_rate_threshold`、`pressure_level_override` 等。
- `oak_vision_system/core/backpressure/types.py`
  - 数据类：`BackpressureState`（normal/pressured/unknown）、`Watermarks`（high/low）、`QueueMetrics`（queue_id、usage、drop_count_delta、pressure_level、timestamp）、
    `BackpressureEventPayload`（queue_id、action、reason、timestamp、metrics 摘要）。
- `oak_vision_system/core/backpressure/metrics_providers.py`
  - 针对 `OverflowQueue` 的 metrics 提供者：读取 `get_usage_ratio()`、`get_drop_count()`、`get_pressure_level()`，计算 `drop_count_delta`（内部保存 last_drop_count）。
- `oak_vision_system/core/backpressure/strategy.py`
  - 决策纯函数：根据水位线（high/low）+ 滞后 + drop_rate/pressure_level 判定 `BackpressureState`，返回 action（PAUSE/RESUME/THROTTLE）。
- `oak_vision_system/core/backpressure/monitor.py`
  - 轻量线程：注册表（queue_id -> metrics_provider, capacity, watermarks, prev_state），周期采样 -> 决策 -> 状态变化时通过事件总线发布 `EventType.BACKPRESSURE_SIGNAL`。
  - 事件 payload 参考：`{"queue_id": ..., "action": "PAUSE|RESUME|THROTTLE", "reason": "queue_high|queue_low|drop_rate|pressure_level", "timestamp": now, "usage": x, "drops": y}`。
- `oak_vision_system/core/backpressure/adapters/overflow_queue.py`
  - （可选）便捷注册工具：封装 register 函数，输入 `OverflowQueue` 和 queue_id，内部构造 metrics_provider 并挂到 monitor。

### 4.2 生产端接入点（结合现有代码）

- 事件总线：使用现有 `core/event_bus`，事件类型 `EventType.BACKPRESSURE_SIGNAL`。
- 生产者（如 `modules/data_collector/collector.py`）：
  - 订阅 `BACKPRESSURE_SIGNAL`，在回调中加锁更新本地标志位（如 `production_mode` 或 `should_pause`）。
  - 生产循环读取标志位：`pause` -> sleep 并 continue；`throttle` -> 按配置 sleep/令牌桶；`full_speed` -> 原逻辑。
  - 可选：在回调里调用 `EventBus.set_flow_control(EventType.RAW_FRAME_DATA, True/False)` 做源头开关。

### 4.3 TODO 列表

1) **配置与类型**
   - 新增 `core/backpressure/config.py`，定义默认阈值与校验。
   - 在 `core/backpressure/types.py` 添加 BackpressureEventPayload、Watermarks、BackpressureState 等数据结构（保留现有 QueueMetrics 语义）。

2) **Metrics Provider**
   - 在 `core/backpressure/metrics_providers.py` 实现 OverflowQueueMetricsProvider：记录 last_drop_count，返回 QueueMetrics（usage=queue.get_usage_ratio()，drop_count_delta=cur-last，pressure_level=queue.get_pressure_level()，timestamp=time.time()）。

3) **策略纯函数**
   - 在 `core/backpressure/strategy.py` 实现 hysteresis + drop_rate/pressure_level 判定：normal→pressured 当 usage>=high 或 drop_count_delta>阈值 或 pressure_level=critical；pressured→normal 当 usage<=low 且 drop_count_delta=0。
   - 输出 BackpressureState + action（PAUSE/RESUME/THROTTLE），其中 THROTTLE 可根据 usage 或 pressure_level=high。

4) **监控线程**
   - 在 `core/backpressure/monitor.py` 编写 BackpressureMonitor：
     - API：`register_queue(queue_id, metrics_provider, capacity)`, `unregister_queue`, `start()`, `stop()`.
     - 预计算水位线：high=capacity*high_ratio，low=capacity*low_ratio（小容量保护）。
     - 循环：快照注册表 -> 采样 metrics -> 决策 -> 状态变化时 publish `BACKPRESSURE_SIGNAL`（包含 queue_id/action/reason/metrics 摘要）。
     - 线程安全：注册表加锁，循环中使用快照减少持锁时间。

5) **生产端接入**
   - 在 `modules/data_collector/collector.py` 添加背压订阅与标志位：
     - 初始化时订阅 BACKPRESSURE_SIGNAL。
     - 回调：按 queue_id/role 匹配，更新 `production_mode`（full_speed/throttle/pause）。
     - 生产循环中根据 mode sleep/continue，避免 busy-wait。
   - 如存在其他生产者模块，同样模式复用。

6) **初始化与导出**
   - 更新 `core/backpressure/__init__.py` 导出新的 Monitor/Config/Types。
   - 在需要处实例化 BackpressureMonitor 并注册队列（示例：Render/Display 模块的 OverflowQueue，或其他生产队列）。

7) **日志与观测**
   - 在 monitor 发布事件时记录日志（queue_id, action, reason, usage, drops）。
   - 可选：在 EventBus 层设置 flow control 开关接口示例。

8) **测试**
   - 单元测试：策略判定（滞后、drop_rate、pressure_level），metrics_provider drop_delta 计算，monitor 状态变化只触发一次事件。
   - 集成测试：模拟 OverflowQueue 写入，验证 BACKPRESSURE_SIGNAL 发布与生产端标志位响应。
