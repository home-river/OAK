# OAK Vision System 配置文件示例

本文档展示基于当前 DTO 架构的完整配置 JSON 示例。

## 配置架构层次

```
DeviceManagerConfigDTO (顶层)
├─ oak_module (OAK模块配置)
│  ├─ hardware_config (OAK硬件配置)
│  ├─ role_bindings (角色绑定)
│  └─ device_metadata (设备元数据)
├─ data_processing_config (数据处理配置)
│  ├─ coordinate_transforms (坐标变换)
│  └─ filter_config (滤波配置)
├─ can_config (CAN通信配置)
├─ display_config (显示配置)
└─ system_config (系统配置)
```

## 完整配置示例

```json
{
  "config_version": "2.0.0",
  
  "oak_module": {
    "hardware_config": {
      "model_path": "/path/to/models/yolov8n_openvino_2022.1_6shave.blob",
      "label_map": ["durian", "person"],
      "num_classes": 2,
      "confidence_threshold": 0.6,
      "nms_threshold": 0.4,
      "max_detections": -1,
      
      "rgb_resolution": [1920, 1080],
      "preview_resolution": [640, 480],
      "hardware_fps": 20,
      "usb2_mode": true,
      
      "enable_depth_output": true,
      "depth_resolution": [640, 480],
      "depth_min_threshold": 400.0,
      "depth_max_threshold": 6000.0,
      "align_depth_to_rgb": true,
      
      "median_filter": 5,
      "left_right_check": true,
      "extended_disparity": false,
      "subpixel": false,
      
      "queue_max_size": 4,
      "queue_blocking": false
    },
    
    "role_bindings": {
      "left_camera": {
        "role": "left_camera",
        "historical_mxids": [
          "14442C10D13D0D0000",
          "14442C10D13D0D0001"
        ],
        "active_mxid": null,
        "last_active_mxid": "14442C10D13D0D0000"
      },
      "right_camera": {
        "role": "right_camera",
        "historical_mxids": [
          "14442C20E24E1E0000"
        ],
        "active_mxid": null,
        "last_active_mxid": "14442C20E24E1E0000"
      }
    },
    
    "device_metadata": {}
  },
  
  "data_processing_config": {
    "coordinate_transforms": {
      "left_camera": {
        "role": "left_camera",
        "translation_x": 0.0,
        "translation_y": 0.0,
        "translation_z": 0.0,
        "roll": 0.0,
        "pitch": 0.0,
        "yaw": 0.0,
        "calibration_date": "2025-10-10",
        "calibration_method": "manual",
        "calibration_accuracy": 2.5
      },
      "right_camera": {
        "role": "right_camera",
        "translation_x": 500.0,
        "translation_y": 0.0,
        "translation_z": 0.0,
        "roll": 0.0,
        "pitch": 0.0,
        "yaw": 0.0,
        "calibration_date": "2025-10-10",
        "calibration_method": "manual",
        "calibration_accuracy": 2.5
      }
    },
    
    "filter_config": {
      "filter_type": "moving_average",
      "moving_average_config": {
        "window_size": 5,
        "weighted": false
      },
      "kalman_config": null,
      "lowpass_config": null,
      "median_config": null
    },
    
    "enable_data_logging": false,
    "processing_thread_priority": 5,
    "person_timeout_seconds": 5.0
  },
  
  "can_config": {
    "enable_can": false,
    "can_interface": "socketcan",
    "can_channel": "can0",
    "can_bitrate": 250000,
    "send_timeout_ms": 100,
    "receive_timeout_ms": 200,
    "frame_id_config": null
  },
  
  "display_config": {
    "enable_display": true,
    "default_display_mode": "combined",
    "enable_fullscreen": false,
    "window_width": 1280,
    "window_height": 720,
    "window_position_x": 100,
    "window_position_y": 100,
    
    "target_fps": 20,
    "enable_vsync": false,
    
    "show_detection_boxes": true,
    "show_labels": true,
    "show_confidence": true,
    "show_coordinates": true,
    "show_fps": true,
    "show_device_info": true,
    
    "depth_colormap": "JET",
    "depth_alpha": 0.6,
    "normalize_depth": true,
    
    "bbox_thickness": 2,
    "bbox_color_by_label": true,
    "text_scale": 0.6
  },
  
  "system_config": {
    "log_level": "INFO",
    "log_to_file": false,
    "log_file_path": null,
    "log_max_size_mb": 100,
    "log_backup_count": 7,
    "log_rotate_mode": "time",
    "log_rotate_when": "MIDNIGHT",
    "log_rotate_interval": 1,
    "log_rotate_utc": false,
    
    "enable_profiling": false,
    "max_worker_threads": 4,
    "enable_gpu_acceleration": false,
    
    "auto_reconnect": true,
    "reconnect_interval": 5.0,
    "max_reconnect_attempts": 10,
    "graceful_shutdown_timeout": 5.0,
    
    "enable_data_recording": false,
    "recording_output_dir": null,
    "recording_format": "hdf5"
  }
}
```

## 最小化配置示例

仅包含必需字段的最小配置（使用默认值）：

```json
{
  "config_version": "2.0.0",
  
  "oak_module": {
    "hardware_config": {
      "model_path": "/path/to/model.blob"
    },
    
    "role_bindings": {
      "left_camera": {
        "role": "left_camera",
        "historical_mxids": ["14442C10D13D0D0000"],
        "last_active_mxid": "14442C10D13D0D0000"
      }
    },
    
    "device_metadata": {}
  }
}
```

## 字段说明

### 1. 顶层配置

| 字段 | 类型 | 说明 | 默认值 |
|------|------|------|--------|
| config_version | string | 配置版本号 | "2.0.0" |

### 2. OAK模块配置 (oak_module)

#### 2.1 硬件配置 (hardware_config)

**检测模型配置**
- `model_path`: 模型文件路径（.blob格式）
- `label_map`: 检测类别标签列表
- `num_classes`: 类别数量
- `confidence_threshold`: 置信度阈值 (0.0-1.0)
- `nms_threshold`: NMS阈值 (0.0-1.0)
- `max_detections`: 最大检测数量 (-1表示不限制)

**相机硬件参数**
- `rgb_resolution`: RGB相机分辨率 [宽, 高]
- `preview_resolution`: 预览分辨率 [宽, 高]
- `hardware_fps`: 硬件帧率 (1-120)
- `usb2_mode`: 是否使用USB2模式

**深度计算参数**
- `enable_depth_output`: 是否启用深度功能
- `depth_resolution`: 深度图分辨率 [宽, 高]
- `depth_min_threshold`: 最小有效深度(mm)
- `depth_max_threshold`: 最大有效深度(mm)
- `align_depth_to_rgb`: 深度图对齐到RGB
- `median_filter`: 中值滤波核大小 (3/5/7)
- `left_right_check`: 左右一致性检查
- `extended_disparity`: 扩展视差范围
- `subpixel`: 亚像素精度

**Pipeline队列配置**
- `queue_max_size`: 输出队列最大长度 (1-30)
- `queue_blocking`: 队列满时是否阻塞

#### 2.2 角色绑定 (role_bindings)

每个角色包含：
- `role`: 角色标识 ("left_camera"/"right_camera")
- `historical_mxids`: 历史设备MXid列表（最多5个）
- `active_mxid`: 当前激活MXid（运行时字段，持久化时为null）
- `last_active_mxid`: 上次使用的MXid

#### 2.3 设备元数据 (device_metadata)

**重要说明**：`device_metadata` 为纯运行时字段，**不持久化到配置文件**。

- 配置文件中保存为空字典：`"device_metadata": {}`
- 程序启动时通过 `OAKDeviceDiscovery.discover_devices()` 自动填充
- 每个设备包含以下运行时字段：
  - `mxid`: 设备MXid（主键）
  - `product_name`: 产品名称（如"OAK-D"）
  - `connection_status`: 连接状态
  - `notes`: 备注（可选，运行时生成）
  - `first_seen`: 首次发现时间戳
  - `last_seen`: 最后发现时间戳

**设计优势**：
- 配置文件简洁，无需维护设备信息
- 设备信息始终为最新（每次启动时重新发现）
- 避免持久化数据与实际设备状态不一致

### 3. 数据处理配置 (data_processing_config)

#### 3.1 坐标变换 (coordinate_transforms)

按角色配置，每个变换包含：
- `role`: 角色标识
- `translation_x/y/z`: 平移参数(mm)
- `roll/pitch/yaw`: 旋转参数(度)
- `calibration_date`: 标定日期
- `calibration_method`: 标定方法 ("manual"/"auto")
- `calibration_accuracy`: 标定精度(mm)

#### 3.2 滤波配置 (filter_config)

- `filter_type`: 滤波器类型 ("moving_average"/"kalman"/"lowpass"/"median")
- 各滤波器配置（根据filter_type选择对应配置）：
  - `moving_average_config`: 滑动平均滤波器
    - `window_size`: 窗口大小
    - `weighted`: 是否加权
  - `kalman_config`: 卡尔曼滤波器
  - `lowpass_config`: 低通滤波器
  - `median_config`: 中值滤波器

### 4. CAN通信配置 (can_config)

- `enable_can`: 是否启用CAN通信
- `can_interface`: CAN接口类型
- `can_channel`: CAN通道
- `can_bitrate`: 波特率
- `send_timeout_ms`: 发送超时(ms)
- `receive_timeout_ms`: 接收超时(ms)

### 5. 显示配置 (display_config)

**窗口配置**
- `enable_display`: 是否启用显示
- `default_display_mode`: 显示模式 ("rgb"/"depth"/"combined"/"side_by_side")
- `window_width/height`: 窗口尺寸
- `window_position_x/y`: 窗口位置

**渲染参数**
- `target_fps`: 目标显示帧率
- `show_detection_boxes`: 显示检测框
- `show_labels`: 显示标签
- `show_confidence`: 显示置信度
- `show_coordinates`: 显示3D坐标
- `show_fps`: 显示帧率
- `show_device_info`: 显示设备信息

**深度图显示**
- `depth_colormap`: 颜色映射 ("JET"/"RAINBOW"/"BONE"等)
- `depth_alpha`: 透明度 (0.0-1.0)
- `normalize_depth`: 归一化显示

**检测框样式**
- `bbox_thickness`: 边框粗细
- `bbox_color_by_label`: 按标签着色
- `text_scale`: 文字大小

### 6. 系统配置 (system_config)

**日志配置**
- `log_level`: 日志级别 ("DEBUG"/"INFO"/"WARNING"/"ERROR"/"CRITICAL")
- `log_to_file`: 是否写入文件
- `log_file_path`: 日志文件路径
- `log_max_size_mb`: 单个日志文件最大大小(MB)（仅在按大小滚动时生效）
- `log_backup_count`: 日志文件备份数量/保留天数（按时间滚动时为保留天数）
- `log_rotate_mode`: 滚动模式 ("time"/"size")
- `log_rotate_when`: 时间粒度 ("S"/"M"/"H"/"D"/"MIDNIGHT"/"W0"-"W6")（仅在按时间滚动时生效）
- `log_rotate_interval`: 时间间隔（>=1，按时间滚动时生效）
- `log_rotate_utc`: 是否按 UTC 基准滚动（按时间滚动时生效）

**性能配置**
- `enable_profiling`: 启用性能分析
- `max_worker_threads`: 最大工作线程数
- `enable_gpu_acceleration`: 启用GPU加速

**系统行为**
- `auto_reconnect`: 自动重连
- `reconnect_interval`: 重连间隔(秒)
- `max_reconnect_attempts`: 最大重连次数
- `graceful_shutdown_timeout`: 优雅关闭超时(秒)

**数据录制**
- `enable_data_recording`: 启用数据录制
- `recording_output_dir`: 录制输出目录
- `recording_format`: 录制格式 ("hdf5"/"csv"/"json"/"pickle")

## 配置文件路径

默认配置文件路径：`oak_vision_system/config/device_config.json`

## 使用示例

### Python 代码加载配置

```python
from core.dto.config_dto import DeviceManagerConfigDTO

# 从JSON文件加载
with open('config/device_config.json', 'r') as f:
    config_dict = json.load(f)
    config = DeviceManagerConfigDTO.from_dict(config_dict)

# 验证配置
if config.validate():
    print("配置有效")
else:
    print("配置错误:", config.get_validation_errors())

# 访问配置
print(f"模型路径: {config.oak_module.hardware_config.model_path}")
print(f"左相机MXid: {config.get_active_mxid(DeviceRole.LEFT_CAMERA)}")
```

### 保存配置

```python
# 修改配置
config.oak_module.hardware_config.confidence_threshold = 0.7

# 序列化为JSON
config_dict = config.to_dict()

# 保存到文件
with open('config/device_config.json', 'w') as f:
    json.dump(config_dict, f, indent=2, ensure_ascii=False)
```

## 注意事项

1. **运行时字段与持久化策略**：
   - `active_mxid`：运行时字段，持久化时为 null
   - `device_metadata`：**完全不持久化**，配置文件中为空字典 `{}`，程序启动时由设备发现器自动填充
   - 这样设计的优势：配置文件简洁，设备信息始终为最新，无数据不一致问题

2. **设备发现与元数据填充流程**：
   ```python
   # 程序启动时
   config = load_config()  # 加载持久化配置（device_metadata 为空字典）
   
   # 发现在线设备并填充元数据
   devices = OAKDeviceDiscovery.discover_devices()
   for device in devices:
       # 直接添加到运行时元数据字典
       config.oak_module.device_metadata[device.mxid] = device
   
   # 此时 device_metadata 包含所有在线设备的完整信息
   ```

3. **枚举值**：所有枚举字段（如 `role`、`filter_type`）需使用对应的字符串值

4. **配置验证**：加载配置后务必调用 `validate()` 方法验证完整性

5. **角色绑定持久化**：`role_bindings` 中的 `historical_mxids` 和 `last_active_mxid` 需要持久化，用于设备热插拔后的自动识别

