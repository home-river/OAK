# 实施计划：决策层模块

## 概述

本实施计划将决策层模块的设计转化为可执行的编码任务。决策层是数据处理流水线的核心决策组件，采用全局单例模式，负责状态管理、人员警告和全局目标选择。实施将按照增量方式进行，每个任务构建在前一个任务的基础上，确保功能逐步完善并通过测试验证。

## 任务列表

- [x] 1. 创建基础数据结构和枚举类型
  - 创建 `oak_vision_system/modules/data_processing/decision_layer/` 目录
  - 实现 `PersonWarningState` 枚举（SAFE/PENDING/ALARM）
  - 实现 `PersonWarningStatus` 枚举（TRIGGERED/CLEARED）
  - 实现 `DetectionStatusLabel` 整数枚举（物体状态 0-99，人员状态 100-199）
  - 实现 `DeviceState` 数据类
  - 实现 `GlobalTargetObject` 数据类
  - _需求：需求 5.1, 6.3, 3.1, 10.3-10.7_

- [x] 2. 创建配置 DTO 类
  - [x] 2.1 实现 `GraspZoneConfigDTO` 类
    - 支持矩形模式（x_min, x_max, y_min, y_max）
    - 支持半径模式（r_min, r_max）
    - 实现 `_validate_data()` 方法验证配置参数
    - _需求：12.7, 12.8, 12.10_

  - [x] 2.2 实现 `ObjectZonesConfigDTO` 类
    - 包含 danger_y_threshold 配置
    - 包含 grasp_zone 子配置
    - 实现 `_validate_data()` 方法
    - _需求：12.4, 12.5, 12.6_

  - [x] 2.3 实现 `PersonWarningConfigDTO` 类
    - 包含 d_in, d_out, T_warn, T_clear, grace_time 配置
    - 实现 `_validate_data()` 方法，验证 d_out > d_in
    - _需求：12.2, 12.3, 12.10_

  - [x] 2.4 实现 `DecisionLayerConfigDTO` 类
    - 包含 person_label_ids, person_warning, object_zones, state_expiration_time
    - 实现 `_validate_data()` 方法，调用所有子配置的验证
    - _需求：12.1, 12.9, 12.11, 12.12_

  - [x] 2.5 更新 `DataProcessingConfigDTO` 类
    - 添加 decision_layer_config 字段
    - 更新 `_validate_data()` 方法包含决策层配置验证
    - _需求：12.1_

- [x] 3. 实现 DecisionLayer 核心类框架
  - [x] 3.1 实现单例模式
    - 实现 `__new__` 方法（双重检查锁定）
    - 实现 `__init__` 方法（防止重复初始化）
    - 实现 `get_instance()` 类方法
    - _需求：14.1-14.7_

  - [x] 3.2 初始化内部状态
    - 初始化事件总线引用
    - 初始化配置对象
    - 初始化设备状态字典 `_device_states`
    - 初始化全局目标对象和线程锁 `_target_lock`
    - _需求：10.1, 10.8, 13.2, 13.7_

  - [x] 3.3 实现输入验证方法 `_validate_input()`
    - 验证坐标数组类型和形状 (N, 3)
    - 验证标签数组类型和形状 (N,)
    - 验证长度一致性
    - 抛出 ValueError 异常
    - _需求：16.1, 16.2, 17.6_

- [x] 4. 实现数据分流和主方法
  - [x] 4.1 实现 `states_to_labels()` 辅助函数
    - 将整数状态数组转换为 DetectionStatusLabel 枚举列表
    - _需求：1.8, 3.6_

  - [x] 4.2 实现 `decide()` 主方法
    - 调用 `_validate_input()` 验证输入
    - 处理空输入情况
    - 使用 `np.isin()` 创建 person_mask 和 object_mask
    - 调用 `_process_person()` 和 `_process_object()`
    - 使用掩码合并状态数组
    - 调用 `states_to_labels()` 转换为枚举列表
    - 返回状态标签列表
    - _需求：1.1-1.9, 2.1-2.7, 3.1-3.8, 17.1-17.7_

- [x] 5. 实现人员处理逻辑
  - [x] 5.1 实现 `_update_person_state_machine()` 方法
    - 实现 SAFE → PENDING 转换（距离 < d_in）
    - 实现 PENDING → ALARM 转换（t_in >= T_warn）
    - 实现 PENDING → SAFE 转换（距离 >= d_out）
    - 实现 ALARM → SAFE 转换（t_out >= T_clear）
    - 处理宽限期逻辑（grace_time）
    - 更新 t_in 和 t_out 时间累计
    - _需求：5.1-5.10_

  - [x] 5.2 实现 `_publish_warning_event()` 方法
    - 构造事件数据（status, timestamp）
    - 通过事件总线发布 PERSON_WARNING 事件
    - _需求：6.1-6.6_

  - [x] 5.3 实现 `_process_person()` 方法
    - 处理空输入
    - 使用向量化操作计算欧几里得距离
    - 获取或创建设备状态
    - 找到最近人员距离
    - 调用 `_update_person_state_machine()` 更新状态
    - 检测状态转换并调用 `_publish_warning_event()`
    - 使用 `np.where` 向量化分配状态值
    - 返回整数状态数组
    - _需求：4.1-4.7, 5.1-5.10, 6.1-6.6_

- [x] 6. 实现物体处理逻辑
  - [x] 6.1 实现 `_update_global_target()` 方法
    - 收集所有未过期设备的最近可抓取物体
    - 检查设备状态过期（超过 state_expiration_time）
    - 清空过期设备的最近物体状态
    - 使用线程锁保护全局目标对象
    - 选择距离最近的物体作为全局目标
    - _需求：9.1-9.9, 11.1-11.6, 13.2, 13.7_

  - [x] 6.2 实现 `_process_object()` 方法
    - 处理空输入
    - 使用向量化操作判断危险区（|y| < danger_y_threshold）
    - 实现矩形抓取区域判断
    - 实现半径抓取区域判断（可选）
    - 使用 `np.where` 分配初始状态值
    - 筛选可抓取物体并计算距离
    - 更新设备最近可抓取物体状态
    - 调用 `_update_global_target()` 更新全局目标
    - 使用线程锁标记待抓取目标状态
    - 返回整数状态数组
    - _需求：7.1-7.10, 8.1-8.8, 9.1-9.9_

- [x] 7. 实现同步访问接口
  - 实现 `get_target_coords_snapshot()` 方法
  - 使用线程锁保护访问
  - 返回目标坐标的副本（如果存在）
  - 返回 None（如果不存在）
  - 确保响应时间 < 0.1ms
  - _需求：13.1-13.8_
  - **注意**：开发环境性能测试结果为 0.0005ms（P99），远超目标。但需要在目标硬件（香橙派）上进行实机验证，因为目标硬件性能较低。

- [x] 8. Checkpoint - 核心功能完成
  - 确保所有核心方法实现完成
  - 确保代码通过静态类型检查
  - 询问用户是否有问题

- [x] 9. 编写单元测试
  - [x] 9.1 测试基础功能

    - 测试空输入返回空列表
    - 测试输入验证错误处理
    - 测试单例模式
    - _需求：1.3, 16.1, 14.1-14.7_

  - [x]* 9.2 测试数据分流
    - 测试 person_mask 和 object_mask 创建
    - 测试标签映射正确性
    - _需求：2.1-2.7_

  - [x]* 9.3 测试人员处理
    - 测试距离计算
    - 测试距离阈值判断（d_in, d_out）
    - 测试状态机转换
    - 测试警告事件发布
    - 测试宽限期逻辑
    - _需求：4.1-4.7, 5.1-5.10, 6.1-6.6_

  - [x]* 9.4 测试物体处理
    - 测试区域判断（危险区/抓取区/超出范围）
    - 测试矩形和半径抓取区域
    - 测试最近物体选择
    - 测试全局目标选择
    - 测试待抓取目标标记
    - _需求：7.1-7.10, 8.1-8.8, 9.1-9.9_

  - [x]* 9.5 测试状态管理
    - 测试设备状态创建和更新
    - 测试状态过期检查
    - _需求：10.1-10.8, 11.1-11.6_

  - [x]* 9.6 测试线程安全
    - 测试并发访问 get_target_coords_snapshot()
    - 测试并发更新全局目标
    - 测试锁竞争情况
    - _需求：13.1-13.8, 14.2_

  - [x]* 9.7 测试配置验证
    - 测试配置参数验证
    - 测试无效配置错误处理
    - _需求：12.10_

- [x] 10. 编写基于属性的测试
  - [ ]* 10.1 属性 1：输出长度与输入一致性
    - **属性 1：输出长度与输入一致性**
    - **验证需求：1.2, 1.9, 3.8, 17.1, 17.2**

  - [ ]* 10.2 属性 2：数据分流正确性
    - **属性 2：数据分流正确性**
    - **验证需求：2.6, 2.7**

  - [ ]* 10.3 属性 3：状态数组到枚举列表转换正确性
    - **属性 3：状态数组到枚举列表转换正确性**
    - **验证需求：3.6**

  - [ ]* 10.4 属性 4：人员距离计算正确性
    - **属性 4：人员距离计算正确性**
    - **验证需求：4.2**

  - [ ]* 10.5 属性 5：人员距离阈值判断正确性
    - **属性 5：人员距离阈值判断正确性**
    - **验证需求：4.3, 4.4, 5.2**

  - [ ]* 10.6 属性 6：人员警告状态机转换正确性
    - **属性 6：人员警告状态机转换正确性**
    - **验证需求：5.3, 5.6**

  - [ ]* 10.7 属性 7：人员警告事件发布正确性
    - **属性 7：人员警告事件发布正确性**
    - **验证需求：6.1, 6.2, 6.5**

  - [ ]* 10.8 属性 8：物体区域判断正确性
    - **属性 8：物体区域判断正确性**
    - **验证需求：7.3, 7.4, 7.5**

  - [ ]* 10.9 属性 9：最近可抓取物体选择正确性
    - **属性 9：最近可抓取物体选择正确性**
    - **验证需求：8.3, 9.3**

  - [ ]* 10.10 属性 10：待抓取目标状态标记正确性
    - **属性 10：待抓取目标状态标记正确性**
    - **验证需求：9.6**

  - [ ]* 10.11 属性 11：设备状态过期处理正确性
    - **属性 11：设备状态过期处理正确性**
    - **验证需求：11.3, 11.4**

  - [ ]* 10.12 属性 12：目标坐标副本返回正确性
    - **属性 12：目标坐标副本返回正确性**
    - **验证需求：13.3, 13.4**

  - [ ]* 10.13 属性 13：输入验证正确性
    - **属性 13：输入验证正确性**
    - **验证需求：16.1**

- [x] 11. 集成到 DataProcessor
  - [x] 11.1 更新 DataProcessor 初始化
    - 从 DataProcessingConfigDTO 读取决策层配置
    - 初始化 DecisionLayer 单例
    - 传递事件总线引用
    - _需求：12.1_

  - [x] 11.2 更新数据处理流程
    - 在滤波后调用 `decision_layer.decide()`
    - 将状态标签添加到 DeviceProcessedDataDTO
    - 处理决策层异常
    - _需求：1.1, 1.2_

  - [ ]* 11.3 编写集成测试
    - 测试完整数据处理流程
    - 测试多设备并发处理
    - 测试事件发布集成
    - _需求：1.1-1.9_

- [ ] 12. 性能优化和验证
  - [ ]* 12.1 性能基准测试
    - 测试 decide() 方法性能（典型场景 10-20 对象）
    - 测试 decide() 方法性能（大量对象 50+）
    - 测试 get_target_coords_snapshot() 性能
    - 验证性能目标：< 5ms（典型），< 20ms（大量），< 0.1ms（快照）
    - _需求：15.1, 15.2, 13.5_

  - [ ]* 12.2 内存和资源分析
    - 分析内存使用情况
    - 检查是否有内存泄漏
    - 验证向量化操作效率
    - _需求：15.6, 15.7, 15.10_

- [ ] 13. 文档和示例
  - [ ]* 13.1 添加代码文档字符串
    - 为所有公共方法添加详细文档
    - 为所有私有方法添加简要文档
    - 添加使用示例

  - [ ]* 13.2 创建配置示例文件
    - 创建 `config/data_processing.json` 示例
    - 包含决策层配置示例
    - 添加注释说明
    - _需求：12.1_

  - [ ]* 13.3 更新集成文档
    - 更新 DataProcessor 集成说明
    - 添加 CAN 通信模块使用示例
    - 添加事件订阅示例

- [ ] 14. Final Checkpoint - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行集成测试
  - 运行性能测试
  - 确保代码覆盖率 > 90%
  - 询问用户是否有问题

## 注意事项

- 任务标记 `*` 的为可选任务，可以根据需要跳过以加快 MVP 开发
- 每个任务引用了相关的需求编号，便于追溯
- 属性测试使用 Hypothesis 库，每个测试至少运行 100 次迭代
- 所有测试必须使用注释标记引用设计文档中的属性
- 性能测试确保满足设计要求（5ms 典型场景，20ms 大量对象）
- 线程安全测试验证并发访问的正确性
