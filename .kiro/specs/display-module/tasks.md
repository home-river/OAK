# 实施计划：显示模块（Display Module）

## 概述

本实施计划将显示模块的设计转换为可执行的任务列表。任务按照 MVP 优先的原则组织，先实现核心功能验证数据流，再实现完整功能。

**当前实现状态：**
- ✅ RenderPacketPackager（适配器子模块）已完全实现
- ✅ RenderPacket 数据类已实现
- ✅ DisplayConfigDTO 配置类已实现
- ⏳ DisplayRenderer（渲染器子模块）待实现
- ⏳ DisplayManager（主控制器）待实现

## 任务列表

### MVP 任务（P0 - 必须实现）

- [x] 1. 创建 DisplayRenderer 基础类结构
  - 创建文件 `oak_vision_system/modules/display_modules/display_renderer.py`
  - 定义 DisplayRenderer 类，包含初始化、线程管理和主循环框架
  - 实现 `__init__` 方法（接收配置、打包器、设备列表）
  - 实现 `start()` 和 `stop()` 方法（线程管理）
  - 实现 `_run_main_loop()` 方法框架（主循环）
  - 添加必要的导入和日志配置
  - _需求：1.1, 1.2, 1.3, 1.7_

- [x] 2. 实现基础窗口显示功能
  - [x] 2.1 实现窗口创建和管理
    - 实现 `_get_or_create_window()` 方法
    - 为每个设备创建独立的 OpenCV 窗口
    - 使用设备别名或设备ID作为窗口名称
    - 设置窗口大小（从配置读取）
    - 维护窗口字典（device_id → window_name）
    - _需求：2.1, 2.7, 16.2, 16.6_
  
  - [x] 2.2 实现视频帧渲染
    - 实现 `_render_packet()` 方法
    - 调用 `packager.get_packets()` 获取所有设备的渲染包
    - 提取 RGB 帧（`packet.video_frame.rgb_frame`）
    - 复制帧数据（避免修改原始数据）
    - 调用 `cv2.imshow()` 显示图像
    - _需求：2.2, 2.3_
  
  - [x] 2.3 实现键盘事件处理
    - 在主循环中调用 `cv2.waitKey(1)`
    - 检测 'q' 键，设置停止信号
    - 在停止时调用 `cv2.destroyAllWindows()`
    - _需求：2.5, 2.6_
  
  - [x] 2.4 实现多设备支持
    - 循环处理 `get_packets()` 返回的所有设备
    - 为每个设备独立渲染
    - 处理队列为空的情况（使用缓存帧）
    - _需求：2.7, 16.3, 16.4_

- [x] 3. 实现基础检测框绘制
  - [x] 3.1 实现检测框绘制方法
    - 实现 `_draw_detection_boxes()` 方法
    - 检查检测数据是否为空（`coords.shape[0] == 0`）
    - 如果为空，直接返回（不绘制）
    - 提取边界框数组（`processed_data.bbox`）
    - 使用固定颜色（绿色：`(0, 255, 0)`）
    - 使用固定粗细（2 像素）
    - 使用 `cv2.rectangle()` 绘制矩形框
    - _需求：3.1, 3.2, 3.3, 3.4_
  
  - [x] 3.2 集成检测框绘制到渲染流程
    - 在 `_render_packet()` 中调用 `_draw_detection_boxes()`
    - 在显示图像之前绘制检测框
    - 添加错误处理（绘制失败时记录日志但继续显示）
    - _需求：3.1_
  
  - [x] 3.3 测试空检测帧处理

    - 验证空检测帧不崩溃
    - 验证仅显示视频帧，不绘制任何内容
    - _需求：3.5, 3.6, 15.1, 15.2_

- [x] 4. 实现 DisplayManager 主控制器
  - [x] 4.1 创建 DisplayManager 类
    - 创建文件 `oak_vision_system/modules/display_modules/display_manager.py`
    - 定义 DisplayManager 类
    - 实现 `__init__` 方法（接收配置、设备列表、事件总线）
    - 验证配置有效性（调用 `config.validate()`）
    - _需求：1.1, 4.1, 4.6_
  
  - [x] 4.2 创建子模块实例
    - 创建 RenderPacketPackager 实例（传递设备列表）
    - 创建 DisplayRenderer 实例（传递配置和打包器）
    - 存储子模块引用
    - _需求：1.1, 4.2_
  
  - [x] 4.3 实现 start() 方法
    - 启动 RenderPacketPackager（调用 `packager.start()`）
    - 根据 `enable_display` 配置决定是否启动 DisplayRenderer
    - 添加错误处理（启动失败时清理已启动的子模块）
    - 记录启动日志
    - _需求：1.7, 4.3, 4.4_
  
  - [x] 4.4 实现 stop() 方法
    - 停止 DisplayRenderer（调用 `renderer.stop(timeout)`）
    - 停止 RenderPacketPackager（调用 `packager.stop()`）
    - 处理停止超时（记录警告日志）
    - 记录停止日志和统计信息
    - _需求：1.8_
  
  - [x] 4.5 实现 get_stats() 方法
    - 聚合 RenderPacketPackager 的统计信息
    - 聚合 DisplayRenderer 的统计信息
    - 返回包含两个子模块数据的字典
    - _需求：13.1, 13.2_
  
  - [x] 4.6 实现 is_running 属性
    - 检查两个子模块的运行状态
    - 返回布尔值
    - _需求：1.7_

- [x] 5. 错误处理和日志
  - [x] 5.1 DisplayRenderer 错误处理
    - 在主循环中捕获所有异常
    - 渲染失败时记录错误日志并跳过该帧
    - OpenCV 操作失败时记录错误日志并继续运行
    - 队列获取超时时继续循环（不退出）
    - _需求：5.1, 5.2, 5.3, 5.6_
  
  - [x] 5.2 DisplayManager 错误处理
    - 配置无效时抛出 ValueError
    - 子模块启动失败时清理并抛出异常
    - 停止超时时记录警告日志
    - _需求：4.6, 5.5_
  
  - [x] 5.3 添加日志记录
    - 使用 `logging.getLogger(__name__)` 创建日志器
    - 记录关键操作（启动、停止、错误）
    - 避免在主循环中添加 DEBUG 日志（性能考虑）
    - _需求：5.5_

- [x] 6. 更新模块 __init__.py
  - 编辑文件 `oak_vision_system/modules/display_modules/__init__.py`
  - 导入 DisplayManager 类
  - 导入 DisplayRenderer 类
  - 导入 RenderPacket 类（如果尚未导入）
  - 添加到 `__all__` 列表

- [x] 7. MVP 集成测试

  - [x] 7.1 创建集成测试脚本

    - 创建测试脚本 `oak_vision_system/tests/integration/display_modules/test_display_module_mvp.py`
    - 模拟 Collector 发布 RAW_FRAME_DATA 事件
    - 模拟 DataProcessor 发布 PROCESSED_DATA 事件
    - 创建 DisplayManager 实例并启动
    - _需求：所有 MVP 需求_
  
  - [x] 7.2 测试基础显示功能

    - 验证窗口创建成功
    - 验证视频帧显示正常
    - 验证检测框绘制正确
    - 验证按 'q' 键退出
    - _需求：2.1, 2.2, 2.3, 2.5, 3.1_
  
  - [x] 7.3 测试空检测帧处理

    - 发送包含空数组的 DeviceProcessedDataDTO
    - 验证不崩溃
    - 验证仅显示视频帧
    - _需求：3.5, 3.6, 15.1, 15.2_
  
  - [x] 7.4 测试多设备支持

    - 同时发送多个设备的数据
    - 验证每个设备有独立窗口
    - 验证窗口名称包含设备别名
    - _需求：2.7, 16.2, 16.6_
  
  - [x] 7.5 测试缓存机制

    - 停止发送新数据
    - 验证使用缓存帧继续显示
    - 等待缓存过期
    - 验证缓存清理
    - _需求：1.9, 16.4_

- [x] 8. Checkpoint - MVP 验收
  - 确保所有 MVP 功能正常工作，向用户确认是否继续实现完整功能

---

### 完整功能任务（P1 - 后续实现）

- [x] 9. 实现完整的检测信息叠加
  - [x] 9.1 实现标签显示
    - 实现 `_draw_labels()` 方法
    - 检查 `show_labels` 配置
    - 从 `processed_data.labels` 提取标签
    - 在边界框上方绘制标签文本
    - 使用 `cv2.putText()` 绘制文本
    - 使用配置的 `text_scale` 大小
    - _需求：6.1, 6.4, 6.5_
  
  - [x] 9.2 实现置信度显示
    - 检查 `show_confidence` 配置
    - 从 `processed_data.confidence` 提取置信度
    - 格式化为百分比（例如 "95%"）
    - 在标签旁显示置信度
    - _需求：6.2_
  
  - [x] 9.3 实现 3D 坐标显示
    - 实现 `_draw_coordinates()` 方法
    - 检查 `show_coordinates` 配置
    - 从 `processed_data.coords` 提取 3D 坐标
    - 格式化为 "(x, y, z) mm"
    - 在边界框下方显示坐标
    - _需求：6.3, 6.7_
  
  - [x] 9.4 实现文本背景绘制
    - 使用 `cv2.rectangle()` 绘制白色背景矩形
    - 提高文本可读性
    - _需求：6.6_

- [x] 10. 实现按标签着色
  - [x] 10.1 定义颜色映射表
    - 创建预定义颜色列表（至少 10 种颜色）
    - 使用 BGR 格式（OpenCV 格式）
    - 例如：`[(0, 255, 0), (255, 0, 0), (0, 0, 255), ...]`
    - _需求：7.2, 7.3, 7.5_
  
  - [x] 10.2 修改检测框绘制方法
    - 修改 `_draw_detection_boxes()` 方法
    - 检查 `bbox_color_by_label` 配置
    - 如果为 True，根据 label_id 选择颜色
    - 使用 `color = colors[label_id % len(colors)]`
    - 如果为 False，使用固定颜色（绿色）
    - _需求：7.1, 7.4_

- [x] 11. 实现 FPS 和设备信息显示
  - [x] 11.1 实现 FPS 计算
    - 维护帧时间戳队列（最近 1 秒的时间戳）
    - 计算平均帧率（帧数 / 时间间隔）
    - 每秒更新一次 FPS 值
    - _需求：8.3, 8.4_
  
  - [x] 11.2 实现 FPS 显示
    - 实现 `_draw_fps()` 方法
    - 检查 `show_fps` 配置
    - 在窗口左上角显示当前 FPS
    - 格式：`"FPS: 25.3"`
    - 使用半透明背景提高可读性
    - _需求：8.1, 8.6_
  
  - [x] 11.3 实现设备信息显示
    - 实现 `_draw_device_info()` 方法
    - 检查 `show_device_info` 配置
    - 在窗口右上角显示设备信息
    - 格式：`"Device: left_camera (18443010D116441200)"`
    - 使用半透明背景提高可读性
    - _需求：8.2, 8.5, 8.6_

- [x] 12. 实现多种显示模式
  - [x] 12.1 实现深度图可视化
    - 实现 `_visualize_depth()` 方法
    - 提取深度图（`packet.video_frame.depth_frame`）
    - 检查 `normalize_depth` 配置
    - 如果为 True，归一化深度值到 0-255 范围
    - 应用颜色映射（`cv2.applyColorMap()`）
    - 使用配置的 `depth_colormap`
    - 处理无效值（NaN、Inf）
    - **参考**：见 requirements.md 附录B第1节（深度图可视化）的百分位归一化方法
    - _需求：10.1, 10.2, 10.3, 10.4, 10.5, 10.6_
  
  - [x] 12.2 实现显示模式切换
    - 维护当前显示模式状态
    - 从配置读取 `default_display_mode`
    - 检测 'm' 键，切换到下一个模式
    - 模式顺序：rgb → depth → combined → side_by_side → rgb
    - _需求：9.1, 9.2, 9.3_
  
  - [x] 12.3 实现 RGB 模式
    - 仅显示 RGB 图像
    - 在 RGB 图像上绘制检测框和叠加信息
    - _需求：9.1_
  
  - [x] 12.4 实现 Depth 模式
    - 仅显示深度图（伪彩色）
    - 在深度图上绘制检测框和叠加信息
    - _需求：9.1, 9.4_
  
  - [x] 12.5 实现 Combined 模式
    - 使用 `cv2.addWeighted()` 叠加 RGB 和深度图
    - 使用配置的 `depth_alpha` 透明度
    - 在叠加图像上绘制检测框和叠加信息
    - _需求：9.1, 9.4, 9.5_
  
  - [x] 12.6 实现 Side-by-Side 模式
    - 使用 `np.hstack()` 水平拼接 RGB 和深度图
    - 在两个图像上分别绘制检测框和叠加信息
    - **参考**：见 requirements.md 附录B第3节（多设备图像拼接）了解水平拼接的实现方式
    - _需求：9.1, 9.6_

- [x] 13. 实现窗口管理
  - **参考**：见 requirements.md 附录B第5节（窗口大小自适应）了解全屏模式下的窗口尺寸调整策略
  - [x] 13.1 实现窗口位置设置
    - 从配置读取 `window_position_x` 和 `window_position_y`
    - 使用 `cv2.moveWindow()` 设置窗口位置
    - _需求：11.2_
  
  - [x] 13.2 实现全屏模式
    - 从配置读取 `enable_fullscreen`
    - 如果为 True，使用 `cv2.setWindowProperty()` 设置全屏
    - _需求：11.3_
  
  - [x] 13.3 实现全屏切换
    - 检测 'f' 键
    - 切换全屏/窗口模式
    - 使用 `cv2.WINDOW_FULLSCREEN` 和 `cv2.WINDOW_NORMAL`
    - **参考**：见 requirements.md 附录B第2节（全屏切换）的简洁实现方式
    - _需求：11.4_
  
  - [x] 13.4 实现窗口标题设置
    - 在窗口标题显示设备别名
    - 格式：`"{device_alias} - Display"`
    - _需求：11.6_

- [x] 14. 实现性能优化
  - [x] 14.1 实现帧率限制
    - 从配置读取 `target_fps`
    - 计算帧间隔（`1.0 / target_fps`）
    - 在主循环中使用 `time.sleep()` 控制帧率
    - 测量实际帧率，动态调整休眠时间
    - _需求：12.1, 12.2_
  
  - [x] 14.2 优化图像复制
    - 避免不必要的图像复制
    - 直接在原始数组上绘制（如果允许）
    - 使用 NumPy 数组视图而非复制
    - _需求：12.4, 12.5_
  
  - [x] 14.3 监控队列使用率
    - 在 `get_stats()` 中包含队列使用率
    - 记录队列溢出次数
    - 如果队列使用率过高，记录警告日志
    - _需求：12.3, 13.2_

- [x] 15. 实现统计和监控
  - [x] 15.1 实现渲染统计收集
    - 维护渲染帧数计数器
    - 维护 FPS 历史记录
    - 维护运行时长
    - _需求：13.2_
  
  - [x] 15.2 实现 get_stats() 方法
    - 返回当前 FPS
    - 返回总渲染帧数
    - 返回丢弃帧数（来自 RenderPacketPackager）
    - 返回队列使用率
    - 返回运行时长
    - _需求：13.1, 13.2_
  
  - [x] 15.3 实现统计信息线程安全
    - 使用 `threading.Lock()` 保护统计数据
    - 确保多线程访问安全
    - _需求：13.4_
  
  - [ ]* 15.4 实现定期日志输出（可选）
    - 每隔一定时间（例如 60 秒）输出统计信息
    - 使用 INFO 级别日志
    - _需求：13.3_

- [ ] 16. 实现优雅关闭
  - [x] 16.1 实现超时机制
    - 在 `stop()` 方法中使用 `thread.join(timeout)`
    - 如果超时，记录警告日志
    - 强制退出（不等待线程结束）
    - _需求：14.6_
  
  - [x] 16.2 实现资源清理
    - DisplayRenderer 关闭所有 OpenCV 窗口
    - RenderPacketPackager 取消事件订阅
    - 清理队列和缓存
    - _需求：14.2, 14.3, 14.4, 14.5_
  
  - [x] 16.3 输出关闭统计信息
    - 记录总渲染帧数
    - 记录丢弃帧数
    - 记录运行时长
    - 记录平均 FPS
    - _需求：14.7_

- [ ]* 17. 完整功能集成测试
  - [ ]* 17.1 测试所有叠加信息
    - 验证标签显示正确
    - 验证置信度显示正确
    - 验证 3D 坐标显示正确
    - 验证 FPS 显示正确
    - 验证设备信息显示正确
    - _需求：6.1, 6.2, 6.3, 8.1, 8.2_
  
  - [ ]* 17.2 测试按标签着色
    - 验证不同类别使用不同颜色
    - 验证颜色映射正确
    - _需求：7.1_
  
  - [ ]* 17.3 测试所有显示模式
    - 验证 RGB 模式正常
    - 验证 Depth 模式正常
    - 验证 Combined 模式正常
    - 验证 Side-by-Side 模式正常
    - 验证模式切换正常（'m' 键）
    - _需求：9.1, 9.2, 9.3, 9.4, 9.5, 9.6_
  
  - [ ]* 17.4 测试窗口管理
    - 验证窗口大小设置正确
    - 验证窗口位置设置正确
    - 验证全屏模式正常
    - 验证全屏切换正常（'f' 键）
    - _需求：11.1, 11.2, 11.3, 11.4_
  
  - [ ]* 17.5 测试性能
    - 验证帧率满足 target_fps 要求
    - 验证 CPU 占用 < 30%
    - 验证内存占用 < 200MB
    - 验证长时间运行稳定性（无内存泄漏）
    - _需求：12.1, 12.2_
  
  - [ ]* 17.6 测试统计和监控
    - 验证统计信息准确
    - 验证 `get_stats()` 返回正确数据
    - _需求：13.1, 13.2_
  
  - [ ]* 17.7 测试优雅关闭
    - 验证停止时资源正确释放
    - 验证窗口正确关闭
    - 验证统计信息正确输出
    - _需求：14.1, 14.2, 14.3, 14.4, 14.5, 14.7_

- [ ]* 18. 文档和示例
  - [ ]* 18.1 更新模块文档
    - 编辑 `oak_vision_system/modules/display_modules/README.md`
    - 描述模块架构和使用方法
    - 添加配置说明
    - 添加 API 文档
  
  - [ ]* 18.2 创建使用示例
    - 创建 `examples/display_module_example.py`
    - 演示基础使用方法
    - 演示配置选项
    - 演示多设备支持
  
  - [ ]* 18.3 创建性能基准测试
    - 创建 `oak_vision_system/tests/integration/display_modules/test_display_module_benchmark.py`
    - 测量渲染性能
    - 测量内存占用
    - 输出性能报告

- [ ] 19. Checkpoint - 完整功能验收
  - 确保所有完整功能正常工作，进行最终验收

---

## 任务总结

### MVP 任务（P0）- 必须实现

| 任务 | 描述 | 估计时间 |
|------|------|---------|
| 任务 1 | 创建 DisplayRenderer 基础类结构 | 30 分钟 |
| 任务 2 | 实现基础窗口显示功能 | 30 分钟 |
| 任务 3 | 实现基础检测框绘制 | 20 分钟 |
| 任务 4 | 实现 DisplayManager 主控制器 | 40 分钟 |
| 任务 5 | 错误处理和日志 | 15 分钟 |
| 任务 6 | 更新模块 __init__.py | 5 分钟 |
| 任务 7 | MVP 集成测试 | 30 分钟 |
| 任务 8 | Checkpoint - MVP 验收 | - |
| **总计** | **MVP 功能** | **2.5-3 小时** |

### 完整功能任务（P1）- 后续实现

| 任务 | 描述 | 估计时间 |
|------|------|---------|
| 任务 9 | 实现完整的检测信息叠加 | 30 分钟 |
| 任务 10 | 实现按标签着色 | 15 分钟 |
| 任务 11 | 实现 FPS 和设备信息显示 | 20 分钟 |
| 任务 12 | 实现多种显示模式 | 40 分钟 |
| 任务 13 | 实现窗口管理 | 15 分钟 |
| 任务 14 | 实现性能优化 | 20 分钟 |
| 任务 15 | 实现统计和监控 | 15 分钟 |
| 任务 16 | 实现优雅关闭 | 15 分钟 |
| 任务 17 | 完整功能集成测试 | 40 分钟 |
| 任务 18 | 文档和示例 | 30 分钟 |
| 任务 19 | Checkpoint - 完整功能验收 | - |
| **总计** | **完整功能** | **4-4.5 小时** |

---

## 实施建议

1. **按顺序执行 MVP 任务**：先完成任务 1-8，验证核心功能
2. **MVP 验收后再继续**：确保 MVP 功能稳定后再实现完整功能
3. **增量测试**：每完成一个任务就进行测试，及时发现问题
4. **代码审查**：关键任务完成后进行代码审查
5. **性能监控**：持续监控性能指标，确保满足要求

---

## 注意事项

1. **RenderPacketPackager 已实现**：任务 1-8 不需要修改 RenderPacketPackager
2. **配置驱动**：所有功能都应该可以通过 DisplayConfigDTO 配置
3. **错误处理**：所有关键操作都需要添加错误处理
4. **线程安全**：注意多线程访问共享数据的安全性
5. **性能优先**：避免在主循环中添加不必要的日志和操作
6. **向后兼容**：不要修改现有的 DTO 和事件类型
7. **测试任务标记**：带 `*` 的任务为可选测试任务，可根据需要跳过
